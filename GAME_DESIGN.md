# GAME_DESIGN.md

## 追加開発設計書

このドキュメントは、Mystic Isle Adventure の追加開発計画を記載しています。

---

## 1. 現在のゲームフロー
【現在のゲーム（Phase1実装済み）】
1. 島に漂着 → フィールドでスポーン
2. 街に移動 → 王様と会話（クエスト受注）
3. 商人で装備購入 → 銅の剣・木の盾
4. 洞窟攻略（2層）→ 探索
5. 洞窟で宝箱を開ける → Ancient Key入手 ※新ストーリーでは削除予定
6. 街に戻る → 王様と会話
7. 準備を整える → 装備・HP・食料の確認
8. フィールドの遺跡へ → Ancient Keyで扉を開く ※新ストーリーでは遺跡は常に開放
9. ゲームクリア ※新ストーリーでは遺跡内のドラゴン討伐が必要

**現在の実装範囲**:
- シーン: FIELD, TOWN, CAVE（洞窟1のみ、現在は2層構造）
- 敵: 13種類（SLIME, BAT, SPIDER, GHOST, WOLF, SKELETON, LIZARDMAN, VAMPIRE, TROLL, GOLEM, DARK_KNIGHT, REAPER, DRAGON）
- 装備: 剣1種（Bronze Sword）、盾1種（Wood Shield）
- NPC: 王様、商人、宿屋主人
- クリア条件: 遺跡到達（※新ストーリーでは聖剣・聖盾装備が必要）

---

## 2. 追加開発後のストーリー（2000文字以内）

### 「失われた聖鉱石と竜討伐の使命」

**導入部：王様の依頼**

島の西にそびえる古代遺跡に、恐ろしい竜が巣食うようになった。竜の咆哮は日に日に激しくなり、このままでは島全体が危険にさらされる。王様は冒険者を呼び、「遺跡の竜を討伐してほしい。だが、竜の鱗は闇の力で守られており、通常の武器では歯が立たない。倒すには『聖剣』と『聖盾』が必要だ」と告げる。

王様は続ける。「聖盾は我が一族に代々伝わる宝だ。聖剣を手に入れた者にのみ、これを授けよう。聖剣を作れるのは、この街の鍛冶屋だけだが…実は、彼が数日前から行方不明なのだ」。街の人々に話を聞くと、「鍛冶屋は聖剣を作るための材料『聖鉱石』を探しに洞窟1へ向かったが、戻ってこない」という情報が得られる。

**第一章：鍛冶屋の救出**

冒険者は鍛冶屋を探すため、洞窟1へ向かう。洞窟1の最深部（2層）で、魔物に囲まれた鍛冶屋を発見。魔物を倒して鍛冶屋を助け出す。鍛冶屋は感謝しつつも、肩を落として言う。「助けてくれてありがとう。だが、聖鉱石は洞窟1には無かった…古い文献には『聖なる光が眠る洞窟』とあったのだが、どうやら別の洞窟のようだ」。

街へ戻ると、鍛冶屋は礼として「力のハンマー」を冒険者に渡す。「これは特別な力を持つハンマーだ。岩を砕くこともできる。そういえば、東の海岸近くに、昔から岩で塞がれた洞窟があったな…もしかしたら」

**第二章：聖鉱石の発見**

東の海岸へ向かうと、確かに大きな岩で塞がれた洞窟の入口（洞窟2）がある。力のハンマーを使うと、岩が砕け散り、洞窟2への道が開ける。洞窟2の内部には、洞窟1よりも強力な魔物（アイアンゴーレム、ダークエレメンタル、デスナイト）が徘徊している。苦戦しながらも最深部（2層）へ到達し、宝箱の中から輝く「聖鉱石」を発見する。

**第三章：聖剣の錬成**

聖鉱石を持って街へ戻り、鍛冶屋に報告する。鍛冶屋は驚きと喜びの表情で「これだ！これが聖鉱石だ！よくぞ見つけてくれた！」と叫ぶ。鍛冶屋は続ける。「聖剣を作るには、この聖鉱石と『鉄の剣』が必要だ。鉄の剣は商人が売っているはずだ。買ってきてくれれば、すぐに聖剣を錬成しよう」。

冒険者が商人から鉄の剣を購入し、鍛冶屋に渡すと、鍛冶屋は炉を熱し、鉄の剣と聖鉱石を融合させる。激しい光が迸り、やがて「聖剣」が完成する。「見事な剣だ…これなら竜にも対抗できる。さあ、王様のもとへ行くんだ」

**第四章：聖盾の授与**

聖剣を手に王様のもとへ向かうと、王様は感慨深げに剣を見つめる。「これが聖剣…よくぞここまで辿り着いた」。王様は宝物庫から「聖盾」を取り出し、冒険者に授ける。「この盾は代々王家が守ってきた宝だ。聖剣を手にした真の勇者であるお前に、これを託そう。聖剣と聖盾があれば、竜を倒せるはずだ」。

神父は冒険者に祝福を与え、「ここで祈りを捧げれば、あなたの冒険を記録できます。万が一倒れても、ここから再び立ち上がれるでしょう」と告げる。

**最終章：竜との決戦**

聖剣と聖盾を装備し、遺跡へ向かう。遺跡1層には強力な魔物（ストーンガーディアン、カースドアーマー、シャドウビースト）が待ち構えている。遺跡2層の最深部、玉座の間に古代竜が鎮座している。竜は冒険者を見ると、「その光…聖剣と聖盾か。ならば勝負だ、人間よ！」と咆哮し、激しい戦いが始まる。

聖剣だけが竜の鱗を貫き、聖盾だけが竜の炎を防げる。死闘の末、ついに竜を打ち倒すと、竜は「見事だ…これで我も安らげる」と言い残し、光の粒子となって消える。王様は「勇者よ、よくやった！島は救われた！」と感謝し、鍛冶屋は「俺の剣が竜を倒したのか…鍛冶屋冥利に尽きるな」と喜ぶ。神父は「光の祝福がありますように」と祈り、島に平和が戻る。

---

## 3. 追加開発後のゲームフロー
【序盤：依頼と状況把握】
1. 島に漂着 → フィールドでスポーン
2. 神父と会話 → セーブ機能の説明
3. 王様と会話（Phase 0）→ クエスト受注「遺跡の竜を倒せ」
   • 「聖剣と聖盾が必要だ」
   • 「鍛冶屋が行方不明で困っている」
4. 街の人々から情報収集
   • 「鍛冶屋は洞窟1へ聖鉱石を探しに行った」

**【第一章：鍛冶屋救出編】**

6. 商人で銅の剣・木の盾を購入 → 装備強化
7. 洞窟1へ進入（1層→2層）
8. 洞窟1の2層で鍛冶屋を発見 → 魔物と戦闘
9. 鍛冶屋を救出成功（Phase 0→1）
   • 「助けてくれてありがとう。だが聖鉱石は無かった」
10. 街へ帰還
11. 鍛冶屋と会話 → 「力のハンマー」入手
   • 「岩壁を砕く力がある。東の海岸にも塞がれた洞窟があったな」

**【第二章：聖鉱石発見編】**

12. 東の洞窟へ → 洞窟2入口を発見（岩で塞がれている）
13. 力のハンマーを使用 → 岩を破壊、洞窟2へ進入可能に
14. 洞窟2で戦闘と宝箱発見 → さらに装備強化
15. 洞窟2攻略（1層→2層）※新モンスター3種（アイアンゴーレム、ダークエレメンタル、デスナイト）
16. 洞窟2の2層の宝箱から「聖鉱石」入手（Phase 1→2）

**【第三章：聖剣錬成編】**

17. 街へ帰還 → 鍛冶屋に聖鉱石を見せる→「これだ！聖鉱石だ！鉄の剣を買ってきてくれ」
18. 商人から「鉄の剣」を購入（まだ買っていなければ）
19. 鍛冶屋へ → 鉄の剣・聖鉱石で錬成
20.「聖剣」完成！装備（Phase 2→3）

**【第四章：聖盾授与編】**

21. 王様と会話（Phase 3）→ 聖剣を見せる→「よく聖剣を手に入れた。これを授けよう」
22.「聖盾」入手！装備
23. 神父でセーブ → 最終決戦前の準備

**【最終章：竜討伐編】**

24. 遺跡1層へ進入 ※新モンスター3種（ストーンガーディアン、カースドアーマー、シャドウビースト）
25. 遺跡2層へ進む → 最深部の王座の間へ
26. 古代竜と決戦 ※聖剣・聖盾がないとダメージが通らない/防げない
27. 竜を倒す → 遺跡に平和が訪れる（Phase 3→4）
28. **エンディング画面表示** → ゲームクリア
   - 画面が暗転し、エンディングメッセージがオーバーレイで表示される
   - 各NPCからの感謝のメッセージが順に表示される
   - なにかキーを押すと、タイトル画面に戻る

【システム要素】
• 死亡時：神父の教会で復活、Gold/Food半減
• セーブ：神父に話しかける
• ロード：タイトル画面から

---

## 4. キャラクター一覧（追加を明記）

### 既存NPC

| NPC | 場所 | 役割 |
|-----|------|------|
| **王様** | 街 | ストーリーNPC、竜討伐の依頼、聖盾の授与 |
| **商人** | 街 | 機能NPC、アイテム・装備の売買 |
| **宿屋主人** | 街 | 機能NPC、10Goldで休息、HP回復 |

### 追加NPC ⭐

| NPC | 場所 | 役割 |
|-----|------|------|
| **鍛冶屋** ⭐ | 街（救出後）/ 洞窟1 2層（救出前） | ストーリーNPC、聖剣の錬成、力のハンマー授与 |
| **神父** ⭐ | 街・教会 | 機能NPC、セーブポイント、死亡時リスポーン地点 |

---

## 5. モンスター一覧（⭐追加）

### フィールド（3種）

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| SLIME（スライム） | FIELD | 8–12 | 2–3 | 0 | 3–5 | 4–8 |
| BAT（コウモリ） | FIELD | 14–18 | 3–4 | 0–1 | 6–8 | 8–12 |
| SPIDER（クモ） | FIELD | 20–26 | 4–6 | 1–2 | 9–12 | 12–16 |

### 洞窟1（3種）

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| GHOST（ゴースト） | CAVE1 | 28–34 | 6–7 | 2–3 | 12–16 | 16–20 |
| WOLF（ウルフ）⭐ | CAVE1 | 24–32 | 5–7 | 1–2 | 10–14 | 14–18 |
| SKELETON（スケルトン） ⭐| CAVE1 | 32–40 | 6–8 | 2–3 | 14–18 | 18–22 |

### 洞窟2（3種）

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| LIZARDMAN（リザードマン）⭐ | CAVE2 | 40–48 | 8–10 | 3–4 | 20–26 | 24–30 |
| VAMPIRE（ヴァンパイア） | CAVE2 | 36–44 | 7–9 | 3–4 | 18–24 | 22–28 |
| TROLL（トロール） | CAVE2 | 48–58 | 9–11 | 4–5 | 24–32 | 28–36 |

### 遺跡（3種）

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| GOLEM（ゴーレム）⭐ | RUINS | 70–80 | 12–14 | 6–8 | 40–50 | 42–55 |
| DARK_KNIGHT（ダークナイト）⭐ | RUINS | 75–85 | 13–15 | 7–9 | 45–55 | 48–60 |
| REAPER（リーパー）⭐ | RUINS | 80–90 | 14–16 | 8–10 | 50–60 | 52–65 |

### ラスボス

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold | 備考 |
|---|---|---|---|---|---|---|---|
| DRAGON（ドラゴン） | RUINS 最深部 | 120–150 | 18–22 | 10–12 | 100–150 | 100–200 | 聖剣・聖盾が必要 |

---

## 6. MAP一覧（追加を明記）

### 既存MAP

| MAP名 | シーンID | サイズ | 説明 |
|-------|---------|--------|------|
| **FIELD**（フィールド） | FIELD | 24x18 | 島全体、探索、戦闘、各施設への入口 |
| **TOWN**（街） | TOWN | 24x18 | 安全地帯、商人・宿屋主人・王様がいる |
| **CAVE**（洞窟1） | CAVE | 24x18 | 洞窟1層目、中難易度 |
| **CAVE_B2**（洞窟1 地下2階） | CAVE_B2 | 24x18 | 洞窟1の最深部、鍛冶屋救出場所（※宝箱は削除予定） |

### 追加MAP ⭐

| MAP名 | シーンID | サイズ | 説明 |
|-------|---------|--------|------|
| **CAVE2**（洞窟2 1層） ⭐ | CAVE2 | 24x18 | 岩で塞がれた洞窟、高難易度 |
| **CAVE2_B2**（洞窟2 地下2階） ⭐ | CAVE2_B2 | 24x18 | 洞窟2の最深部、聖鉱石の宝箱 |
| **RUINS**（遺跡 1階） ⭐ | RUINS | 24x18 | 古代遺跡、最高難易度 |
| **RUINS_B2**（遺跡 2階） ⭐ | RUINS_B2 | 24x18 | 遺跡の最深部、古代竜との決戦場 |

### MAP遷移図

```
FIELD（フィールド）
├─→ TOWN（街）
├─→ CAVE（洞窟1 1層）
│   └─→ CAVE_B2（洞窟1 地下2階）
├─→ CAVE2（洞窟2 1層） ⭐ ※力のハンマーで岩を破壊後
│   └─→ CAVE2_B2（洞窟2 地下2階） ⭐
└─→ RUINS（遺跡 1階） ⭐
    └─→ RUINS_B2（遺跡 2階） ⭐
```

---

## 7. アイテム一覧（追加を明記）

### 消費アイテム

| アイテム | 効果 | 価格 | 説明 |
|---------|------|------|------|
| Food 10 | Food +10 | 10 Gold | 食料を10回復 |
| Potion | HP +20 | 15 Gold | HPを20回復 |

### 装備アイテム（剣）

| アイテム | ATK | 価格 | 入手方法 | 状態 |
|---------|-----|------|---------|-----|
| **Wood Sword**（木の剣） ⭐ | **+1** | **20 Gold** | **商人** | **追加予定** |
| Bronze Sword（銅の剣） | +2 | 40 Gold | 商人 | 既存 |
| **Iron Sword**（鉄の剣） ⭐ | **+6** | **80 Gold** | **商人** | **追加予定** |
| **Holy Sword**（聖剣） ⭐ | **+10** | **-** | **鍛冶屋が錬成** | **追加予定** |

### 装備アイテム（盾）

| アイテム | DEF | 価格 | 入手方法 | 状態 |
|---------|-----|------|---------|-----|
| Wood Shield（木の盾） | +2 | 35 Gold | 商人 | 既存 |
| **Bronze Shield**（銅の盾） ⭐ | **+4** | **50 Gold** | **商人** | **追加予定** |
| **Iron Shield**（鉄の盾） ⭐ | **+6** | **70 Gold** | **商人** | **追加予定** |
| **Holy Shield**（聖盾） ⭐ | **+10** | **-** | **王様から授与** | **追加予定** |

### ストーリーアイテム（追加予定）

| アイテム | 入手方法 | 用途 | 状態 |
|---------|---------|------|-----|
| **Power Hammer**（力のハンマー） ⭐ | **鍛冶屋救出後にもらう** | **洞窟2の入口の岩を破壊** | **追加予定** |
| **Holy Ore**（聖鉱石） ⭐ | **洞窟2 地下2階の宝箱** | **聖剣の錬成材料（錬成後に消費）** | **追加予定** |

### 削除予定アイテム

| アイテム | 現在の入手方法 | 削除理由 |
|---------|--------------|---------|
| Ancient Key | 洞窟1 地下2階の宝箱 | 新ストーリーでは不要（聖剣・聖盾が遺跡進入の条件） |

**備考**: 洞窟1 地下2階の宝箱も削除予定（聖鉱石は洞窟2に移動）

---

## 8. NPCセリフ一覧

### ストーリーフェーズ定義

| Phase | フェーズ名 | 条件 |
|-------|-----------|------|
| 0 | START | ゲーム開始時 |
| 1 | BLACKSMITH_RESCUED | 鍛冶屋を救出した |
| 2 | ORE_OBTAINED | 聖鉱石を入手した |
| 3 | HOLY_SWORD_CREATED | 聖剣を錬成した |
| 4 | DRAGON_DEFEATED | 竜を倒した（エンディング画面へ遷移） |

**注記**: Phase 4ではドラゴン撃破後に即座にエンディング画面が表示されるため、NPCとの個別会話は発生しません。エンディング画面でNPCからのメッセージが表示されます（9.15参照）。

### 王様のセリフ

**Phase 0: START**（初回会話）

王様: よく来た、若き冒険者よ。[>]
王様: 遺跡に恐ろしい竜が現れた。[>]
王様: 倒すには聖剣と聖盾が必要だ。[>]
王様: だが鍛冶屋が行方不明なのだ。

**Phase 1: BLACKSMITH_RESCUED**（鍛冶屋救出後）

王様: 鍛冶屋を助けてくれたか。[>]
王様: 聖剣には聖鉱石が必要だそうだ。[>]
王様: 鍛冶屋と協力して手に入れてくれ。

**Phase 2: ORE_OBTAINED**（聖鉱石入手後）

王様: 聖鉱石を手に入れたのだな。[>]
王様: 聖剣の完成を待っているぞ。

**Phase 3: HOLY_SWORD_CREATED**（聖剣錬成後）

王様: おお、見事な聖剣ではないか！[>]
王様: 約束通り、聖盾を授けよう。[>]
王様: これで竜を倒せるはずだぞ。[>]
王様: さあ島を救ってくれ、勇者よ！

### 鍛冶屋のセリフ

**Phase 0: START**（救出時・洞窟1 2層）

鍛冶屋: 助けてくれて本当に感謝する！[>]
鍛冶屋: だが聖鉱石は見つからなかった。[>]
鍛冶屋: いったん街へ戻ることにしよう。

**Phase 1: BLACKSMITH_RESCUED**（街に戻った後）

鍛冶屋: 命を助けてくれて本当に感謝だ。[>]
鍛冶屋: 礼に力のハンマーを受け取ってくれ。[>]
鍛冶屋: 東の海岸に岩で塞がれた洞窟がある。[>]
鍛冶屋: そこに聖鉱石があるかもしれん。

**Phase 2: ORE_OBTAINED**（聖鉱石入手後）

鍛冶屋: おお！これこそが聖鉱石だな！[>]
鍛冶屋: 聖剣を作るには鉄の剣も要る。[>]
鍛冶屋: 商人から買ってきてくれないか。

**Phase 3: HOLY_SWORD_CREATED**（鉄の剣持参後・聖剣錬成）

鍛冶屋: よし、鉄の剣も持っているな！[>]
鍛冶屋: 今から聖剣の錬成を始めるぞ。[>]
鍛冶屋: 完成だ！これが聖剣の輝き…[>]
鍛冶屋: 王様から聖盾を授かってくれ。

### 神父のセリフ

**Phase 0: 共通**（常に同じ）

神父: ようこそ、旅の冒険者よ。[>]
神父: ここで祈れば旅路を記録できる。[>]
神父: 倒れてもここから再び立ち上がれる。

---

## 9. 追加開発が必要な機能一覧

### 9.1. セーブ・ロード機能 ⭐

**実装内容**:
- セーブ機能：神父に話しかけると、現在のゲーム状態を`localStorage`に保存
- ロード機能：タイトル画面に「続きから」ボタンを追加、セーブデータから再開
- セーブデータに含める情報：
  - プレイヤーステータス（HP, ATK, DEF, Level, EXP, Food, Gold）
  - インベントリ
  - 装備状態
  - ストーリーフラグ（Phase、鍛冶屋救出、聖鉱石入手など）
  - 現在位置（シーン、座標）
  - 宝箱開封状態
  - 敵討伐状態（ドラゴン討伐フラグなど）

**実装ファイル**:
- `save_system.js`（新規作成） ⭐
- `dialogue.js`（神父の会話に「セーブする」選択肢追加）
- タイトル画面の修正（`renderer/overlay_layer.js`）

---

### 9.2. 死亡ペナルティシステム ⭐

**実装内容**:
- 死亡時、神父の教会で復活
- Gold と Food が半減（切り捨て）
- メッセージ：「神父の祈りで蘇生されました。しかし、力の一部を失ってしまった…」

**実装ファイル**:
- `combat.js`（`handleDefeat()`関数の修正）
- `game_state.js`（`resetPlayerToSafePoint()`の修正）

---

### 9.3. 新MAP追加 ⭐

**実装内容**:
- `CAVE2`（洞窟2 1層）：24x18グリッド
- `CAVE2_B2`（洞窟2 地下2階）：24x18グリッド
- `RUINS`（遺跡 1層）：24x18グリッド
- `RUINS_B2`（遺跡 地下2階）：24x18グリッド

**MAP要件**:
- 洞窟1 地下2階：宝箱を削除（Ancient Key不要のため）
- 洞窟2の入口：フィールドの東の海岸、岩で塞がれている
- 遺跡の入口：フィールドの西側（遺跡は常に進入可能）
- 各MAPに階段（上り・下り）を配置
- 宝箱配置：洞窟2 地下2階に聖鉱石

**実装ファイル**:
- `map_data.js`（MAP定義追加、遷移設定追加、洞窟1の宝箱削除）
- `constants.js`（SCENE定義に追加）

---

### 9.4. 新モンスター追加 ⭐

**実装内容**:
- フィールド専用モンスター3種：
  - SLIME（スライム）
  - BAT（コウモリ）
  - SPIDER（クモ）
- 洞窟1専用モンスター3種：
  - GHOST（ゴースト）
  - WOLF（ウルフ）
  - SKELETON（スケルトン）
- 洞窟2専用モンスター3種：
  - LIZARDMAN（リザードマン）
  - VAMPIRE（ヴァンパイア）
  - TROLL（トロール）
- 遺跡専用モンスター3種：
  - GOLEM（ゴーレム）
  - DARK_KNIGHT（ダークナイト）
  - REAPER（リーパー）
- ボス：DRAGON（ドラゴン）

**実装ファイル**:
- `game_state.js`（ENEMY_DATA に追加）
- `entities/entity_types.js`（ENEMY_KIND に追加）
- `entities/enemy_director.js`（スポーンロジック追加）
- `assets/enemies.png`（スプライト追加） ⭐

---

### 9.5. 新装備追加 ⭐

**実装内容**:
- 剣：Wood Sword（木の剣 ATK+1）、Iron Sword（鉄の剣 ATK+6）、Holy Sword（聖剣 ATK+10）
- 盾：Bronze Shield（銅の盾 DEF+4）、Iron Shield（鉄の盾 DEF+6）、Holy Shield（聖盾 DEF+10）
- 商人の販売リストに木の剣、銅の盾、鉄の剣、鉄の盾を追加
- 聖剣は鍛冶屋が錬成（イベントアイテム）
- 聖盾は王様が授与（イベントアイテム）
- 装備の強さ: 木＜銅＜鉄＜聖

**実装ファイル**:
- `constants.js`（ITEM, PRICE, ITEM_META に追加）
- `data/items.js`（アイテムデータ追加）
- `shop.js`（販売リスト更新）
- `state/player_state.js`（装備ボーナス計算の更新）

---

### 9.6. 鍛冶屋NPC追加 ⭐

**実装内容**:
- 洞窟1 地下2階に鍛冶屋を配置（救出前）
- 救出後、街の鍛冶屋の店に出現
- 会話フェーズに応じてセリフ変化
- 聖剣錬成イベント（鉄の剣 + 聖鉱石 → 聖剣）
- 力のハンマー授与イベント

**実装ファイル**:
- `game_state.js`（鍛冶屋の位置とフラグ管理）
- `dialogue.js`（鍛冶屋の会話データ追加）
- `assets/dialogues.json`（鍛冶屋のセリフ追加）
- `state/occupancy.js`（鍛冶屋の占有管理）

---

### 9.7. 神父NPC追加 ⭐

**実装内容**:
- 街の教会に神父を配置
- セーブ機能の提供
- 死亡時のリスポーン地点
- ロード時のスポーン地点

**実装ファイル**:
- `game_state.js`（神父の位置管理）
- `dialogue.js`（神父の会話データ追加）
- `assets/dialogues.json`（神父のセリフ追加）
- `save_system.js`（セーブ機能の実装）

---

### 9.8. ストーリーアイテム追加 ⭐

**実装内容**:
- 力のハンマー（Power Hammer）：鍛冶屋から入手、洞窟2の岩を破壊
- 聖鉱石（Holy Ore）：洞窟2 地下2階の宝箱、聖剣の材料（錬成後に消費）

**実装ファイル**:
- `constants.js`（ITEM, ITEM_META に追加）
- `data/items.js`（アイテムデータ追加）
- `state/player_state.js`（アイテム使用ロジック）
- `map_data.js`（洞窟2の岩破壊イベント、宝箱配置）

---

### 9.9. ストーリーフラグ管理の拡張 ⭐

**実装内容**:
- 新しいストーリーフラグ：
  - `blacksmithRescued`：鍛冶屋救出
  - `hasHammer`：力のハンマー入手
  - `cave2Unlocked`：洞窟2の岩破壊
  - `hasOre`：聖鉱石入手
  - `holySwordCreated`：聖剣錬成
  - `hasHolyShield`：聖盾入手
  - `dragonDefeated`：竜討伐
- フェーズ管理との統合

**実装ファイル**:
- `state/player_state.js`（フラグ定義と管理）
- `game_state.js`（フラグ参照と更新）

---

### 9.10. 聖剣錬成イベント ⭐

**実装内容**:
- 鍛冶屋に鉄の剣 + 聖鉱石を持っていくと錬成イベント発生
- 鉄の剣と聖鉱石をインベントリから削除（消費）
- アニメーション演出（オプション）
- 聖剣を自動的にインベントリに追加

**実装ファイル**:
- `dialogue.js`（鍛冶屋の会話ロジック）
- `state/player_state.js`（アイテム消費と聖剣追加）

---

### 9.11. 聖盾授与イベント ⭐

**実装内容**:
- 王様に聖剣を見せると聖盾を授与
- 聖盾を自動的にインベントリに追加

**実装ファイル**:
- `dialogue.js`（王様の会話ロジック）
- `state/player_state.js`（聖盾追加）

---

### 9.12. 古代竜ボス戦 ⭐

**実装内容**:
- 遺跡地下2階に古代竜（DRAGON）を固定配置
- 遺跡は常に進入可能（Ancient Key不要）
- 聖剣・聖盾がないとダメージを与えられない/防げない仕様
- 討伐後、ゲームクリア判定

**実装ファイル**:
- `combat.js`（聖剣・聖盾チェックロジック）
- `entities/enemy_director.js`（古代竜のスポーン）
- `game_state.js`（クリア判定、Ancient Key関連のコード削除）

---

### 9.13. 力のハンマーによる岩破壊イベント ⭐

**実装内容**:
- フィールドの東の海岸に岩で塞がれた洞窟2の入口を配置
- 力のハンマー未所持時：「岩が崩れて入れない」メッセージ表示
- 力のハンマー所持時：「岩を崩した！」メッセージ表示、洞窟2に進入可能
- 岩破壊後、洞窟2への遷移が有効化

**実装ファイル**:
- `map_data.js`（岩タイルと洞窟2入口の定義）
- `input/movement_controller.js`（岩破壊イベント処理）
- `state/player_state.js`（力のハンマー所持チェック）

---

### 9.14. UIの調整 ⭐

**実装内容**:
- タイトル画面に「続きから」ボタン追加
- セーブ確認ダイアログ
- 死亡時の復活メッセージ表示

**実装ファイル**:
- `renderer/overlay_layer.js`（タイトル画面、ダイアログ描画）
- `input/overlay_controller.js`（タイトル画面の入力処理）

---

### 9.15. ゲーム終了・エンディング画面 ⭐

**実装内容**:
- ドラゴン撃破時、戦闘終了後に即座にエンディング画面へ遷移
- エンディング画面の表示:
  - 画面全体を暗転（黒背景、透明度240）
  - エンディングメッセージをオーバーレイで表示
  - メッセージ内容:
    1. 「古代竜は光の粒子となって消えた...」
    2. 「島に平和が戻った」
    3. 王様: 「勇者よ、島を救ってくれてありがとう！」
    4. 鍛冶屋: 「俺の剣が役に立ったようだな」
    5. 神父: 「光の祝福がありますように」
    6. 「なにかキーを押してください」
- なにかキーを押すと、タイトル画面に戻る
- タイトル画面から新しいゲームを開始できる

**実装ファイル**:
- `constants.js`（OVERLAY.ENDING を追加）
- `renderer/overlay_layer.js`（エンディング画面の描画関数追加）
- `input/overlay_controller.js`（エンディング画面の入力処理追加）
- `combat.js`（ドラゴン撃破時のエンディング遷移処理）
- `game_state.js`（エンディング後のゲームリセット処理）

---
## 10. 開発計画（改訂版）

### Step 1: 町の基盤機能（神父・セーブ系）
- 目的: 既存タウン環境で神父NPC（9.7）とセーブ/ロード機能（9.1）、死亡ペナルティ（9.2）、タイトルUI調整（9.14）を整備し、長時間テストを可能にする
- 作業: 教会への神父配置と会話追加、save_system.jsとlocalStorage保存/読み込み、スタート画面に「続きから」を追加、敗北時の復活/資源減少ロジックを実装
- 効果: 新マップが未完成でもメタ機能を単体テストでき、以降の作業で安全に状態を記録・再現できる

### Step 2: 装備・経済バランスの先行整備
- 目的: 木/銅/鉄/聖系装備（9.5）を早期に導入し、既存マップ上で攻防バランスを確認できるようにする
- 作業: constants.js・data/items.js・shop.js・player_state.js を更新し、新武器/盾/価格/装備ボーナスを反映、低レベル帯のドロップや販売UIを確認
- 効果: 序盤～中盤の戦闘感触を先に固められるため、後続の敵/マップ調整がやりやすくなる

### Step 3: ストーリー進行フラグとイベント骨格
- 目的: ストーリーフラグ管理（9.9）とイベントアイテム（9.8）、鍛冶屋・王様イベント（9.6, 9.10, 9.11）を整え、進行ロジックをマップ実装前に確立する
- 作業: player_state.js / game_state.js に新フラグを実装、dialogue.js / assets/dialogues.json にフェーズ分岐を追加、Power Hammer・聖鉱石処理や聖剣/聖盾付与の処理を実装
- 効果: 各フラグのON/OFFを手動で切り替えるだけでイベント単体テストができ、マップ導線実装時の不具合を減らせる

### Step 4: マップ拡張と探索イベント
- 目的: 新マップ群（9.3）と岩破壊イベント（9.13）を実装し、鍛冶屋救出や聖鉱石取得などの実地フローを完成させる
- 作業: map_data.js・constants.js に CAVE2/RUINS 系のタイル・遷移を追加、movement_controller.js で岩破壊判定を実装、洞窟/遺跡にNPC・宝箱・聖鉱石を配置、敵スポーン（9.4）をマップごとに調整
- 効果: 実際の移動導線とバトルが繋がり、ストーリーイベントを通しで検証できる

### Step 5: 終盤コンテンツと総合テスト
- 目的: 古代竜戦（9.12）とエンディング画面（9.15）を仕上げ、全機能を通しで検証する
- 作業: combat.js・enemy_director.js でドラゴン専用挙動と聖剣/聖盾チェックを実装、renderer/input 側でエンディング表示/戻り処理を追加、全フェーズの回帰テストと難易度調整を実施
- 効果: リリース前にストーリー完走テストとセーブデータ互換確認ができ、品質を担保できる

---
