# GAME_DESIGEN.md

## リファクタリング設計書

### 目的
- p5.js 初心者でも追いやすい責務分離を行い、シーン追加や UI 拡張の変更範囲を局所化する。
- 状態・描画・入力が循環依存しない構造に改め、テスト容易性と保守性を高める。

### 現状課題
1. `game_state.js` に定数/状態/占有/オーバーレイなどが 1,000 行超で混在し、局所改修でも全体把握が必要。
2. `input.js` が移動・会話・戦闘・UI を単一関数で分岐しており、操作追加やコントローラ対応が困難。
3. `renderer.js` はカメラ計算から戦闘/クリアオーバーレイまで抱えており、描画順やレイアウト変更が難しい。
4. `entities.js` がスプライト描画と敵 AI/スポーン管理を兼任し、敵挙動調整や新規種追加の見通しが悪い。
5. アイテム/ショップ/メッセージ仕様が散在し、`Game.pushMessage` が文字列とオブジェクト混在で UI 表示にばらつきがある。

### 方針概要
| 領域 | 対応内容 |
| --- | --- |
| 状態管理 | 定数・プレイヤー状態・UI 状態・占有管理をモジュール化し、`initializeGame` は依存組み立てに限定。 |
| 入力制御 | フィールド/戦闘/オーバーレイのモード別ハンドラへ分割し、矢印キー連続移動は専用コントローラに集約。 |
| 描画 | カメラ・マップ・エンティティ・UI・オーバーレイを別ファイル化し、`drawAll()` が描画順を制御。 |
| エンティティ/AI | スプライト辞書と敵ディレクターを分離し、AI は占有/経路探索を依存注入で受け取る。 |
| データ/メッセージ | アイテム・ショップ・マップ・ダイアログをデータモジュールに集約し、メッセージ型を統一。 |

### 詳細計画

#### 1. 状態管理レイヤー再構築
1. `config.js` を新設し、キャンバス寸法やタイルサイズなど `Game.config` の唯一の定義源にする。
2. `constants.js` に `SCENE`, `TILE`, `ITEM`, `OVERLAY` などの列挙体をまとめ、描画/入力はここだけを参照。
3. `state/player_state.js` でプレイヤー/インベントリ/進行フラグ操作を管理し、`Game.stateFacade`（例）で API を公開。
4. `state/ui_state.js` と `state/occupancy.js` を切り出し、UI 開閉やタイル占有ロジックを独立させる。
5. `game_state.js` は初期化とファサード設定のみを担い、各モジュールの `init()` を呼ぶ役割に縮小。

#### 2. 入力制御モジュール化
1. `MovementController`：キーリピート状態と `tryMove`、空腹進行を保持し、`update()` で毎フレーム処理。
2. `OverlayController`：インベントリ/ショップ/宿/ステータスの入力を集約し、`Game.ui.state.overlay` を基にディスパッチ。
3. `BattleInput`：`Game.combat` 状態を参照して攻撃/防御/逃走のみを扱う単機能クラスにする。
4. `input/index.js` をモードルーター化し、`Game.mode`（FIELD/BATTLE/OVERLAY）に応じて各コントローラへイベントを転送。

#### 3. 描画レイヤー整理
1. `camera.js`：プレイヤー位置からビューポートを計算し、各レイヤーにオフセットを提供。
2. `renderers/map_layer.js`：タイル描画とスプライト判定のみを担当。フェイルセーフで単色描画を残す。
3. `renderers/entity_layer.js`：プレイヤー/NPC/敵/オブジェクト描画とフォールバック矩形描画を担当。
4. `renderers/ui_panel.js`：メッセージログやステータスをデータ駆動で描画し、フォントや行間設定を構造体で保持。
5. `renderers/overlay_layer.js`：インベントリ・ショップ・戦闘・クリア画面などを共通のフレーム描画で包む。
6. `renderer/index.js` に `drawAll()` を用意し、レイヤー配列を順番に呼び出すだけの薄い実装にする。

#### 4. エンティティと敵 AI
1. `sprite_atlas.js`：アクター/敵/オブジェクトのスプライトインデックスと描画ヘルパーを保持し、描画層はここを利用。
2. `enemy_director.js`：スポーン条件、リスポーンカウンタ、ドラゴン固有処理、追跡 AI を担当。占有・パス探索は引数で受け取りテスト可能にする。
3. `entities/index.js` は公開 API（`spawnInitialEnemies`, `moveEnemies`, `drawEnemies` など）のみを残し、内部では小さなモジュールに委譲。

#### 5. データ定義とメッセージ統一
1. `data/items.js`：アイテム ID とメタ情報（名前/効果/価格）を一元管理し、ショップ/インベントリ/戦闘報酬が共通参照。
2. `data/maps/*.js` または JSON 群：ASCII マップや出入口設定をデータ化し、`map_data.js` は読み込みと検証に集中。
3. `messages/log.js`：`pushMessage({ text, icon?, tone })` 形式を必須にして描画側の整形を単純化。旧 API からの移行用ラッパーを用意。
4. `dialogue.js` や `shop.js` などメッセージを出す箇所は全て新フォーマットに寄せる。

### タスク分解と優先度
1. **状態/定数の分割**：他モジュールが依存する基盤のため最優先で着手。
2. **描画レイヤー再編**：視覚差分が大きくなるため、段階的に導入して動作確認を行う。
3. **入力コントローラ導入**：操作体系変更やデバイス追加に備えて早期に適用。
4. **敵ディレクター刷新**：難易度調整や新敵追加タイミングで行い、AI のテスト環境を整える。
5. **データ/メッセージ統合**：ローカライズや UI 改修が始まるタイミングで実施し、旧データからの移行を完了させる。

### 成功判定
- `game_state.js` を 400 行未満に縮小し、責務ごとのファイル境界を明確化できている。
- `input` 配下でモード別クラスの単体テストが実行でき、操作追加がファイル単位で完結する。
- 描画レイヤーが `drawAll()` の順序差し替えだけで拡張できる。
- 敵スポーンや追跡ロジックがモジュール単体でテスト可能になり、`Game.entities` から分離されている。
- `pushMessage` が統一フォーマットで呼ばれ、UI 表示の崩れがなくなる。
