# リファクタリング設計書とのギャップ更新

**更新日:** 2025-11-12  
**参照設計:** `GAME_DESIGEN.md`（リファクタリング設計書）

今回のアップデートで設計書に残っていた未対応項目（Gap 1.2 / 2.1 / 3.1 / 5.1 / 5.2 / 5.3）はすべて解消されました。以下は設計書のカテゴリ別サマリーと、コード側で確認した根拠です。

---

## 実施状況サマリー

| カテゴリ | 現状 | 備考 |
| --- | --- | --- |
| 1. 状態管理レイヤー再構築 | **100%** | `data/enemies.js` を新設し、`game_state.js:56-61` から参照。ファイル全体は 349 行で成功判定 (400 行未満) を満たす。 |
| 2. 入力制御モジュール化 | **100%** | ルート `input.js` を `input/index.js` に移動し、`index.html:33-36` で読込。Movement/Overlay/Battle 各コントローラが既存通り機能。 |
| 3. 描画レイヤー整備 | **100%** | `renderer/index.js:12-33` に `drawAll()` を追加。`sketch.js:33-40` から単一呼び出しで描画順を集中管理。 |
| 4. エンティティ / 敵 AI | **100%** | `Game.ENEMY_DATA` の依存のみ変更で、`entities/enemy_director.js` 等は従来どおり動作。追加ギャップなし。 |
| 5. データ/メッセージ統合 | **100%** | アイテム定義を `data/items.js` へ分離。`data/maps/*.js` で ASCII マップを管理し、`map_data.js:67-157` が読み込み/検証を担う。`pushMessage` は `game_state.js:101-149` で正規化済み。 |

---

## 詳細レビュー

### 1. 状態管理レイヤー再構築
- **設計要件**: 定数とデータを分離し、`game_state.js` は初期化とファサードに限定する。敵データは専用モジュールで管理。
- **実装確認**:
  - `data/enemies.js:1-63` に `ENEMY_DATA` を定義し、`Game.ENEMY_DATA` へ登録。
  - `game_state.js:56-61` では `Game.ENEMY_DATA` がロード済みか検証し、参照のみを保持。
  - ファイル行数は 349 行で、成功判定「400 行未満」を達成。
- **ギャップ評価**: **解消済み** (旧 Gap 1.1 / 1.2)。

### 2. 入力制御モジュール化
- **設計要件**: ルータを `input/index.js` として `Game.input` を公開し、モード別コントローラへ委譲する。
- **実装確認**:
  - ルータファイルを `input/index.js` に移動 (`index.html:33-36` でロード)。
  - `Game.input.handleKeyPressed/Released/update` は従来通り `movement/overlay/battle` にディスパッチ。
- **ギャップ評価**: **解消済み** (旧 Gap 2.1)。

### 3. 描画レイヤー整備
- **設計要件**: `renderer/index.js` に描画順のファサード (`drawAll`) を置き、`sketch.js` は単一呼び出しにする。
- **実装確認**:
  - `renderer/index.js:12-33` で `rendererFacade.drawAll()` を実装。
  - `sketch.js:33-40` で `Game.renderer.drawAll();` のみを呼び出し、描画順管理が一元化。
- **ギャップ評価**: **解消済み** (旧 Gap 3.1)。

### 4. エンティティ / 敵 AI
- 今回の変更による差分はなし。敵データの移動だけで `entities` 一帯の API には影響なし。

### 5. データ / メッセージ統合
- **アイテム定義 (旧 Gap 5.1)**: `data/items.js:1-70` に ID/表示名/効果/価格を集約し、`Game.PRICE` と `Game.ITEM_META` を自動生成。`constants.js` には列挙体のみ残る。
- **マップ分割 (旧 Gap 5.2)**: `data/maps/field.js` などシーンごとの ASCII を用意し、`map_data.js:67-157` が `Game.mapSources` を検証して各種タイル/スポーン/入口を生成。
- **メッセージ統一 (旧 Gap 5.3)**:
  - `game_state.js:101-149` でメッセージオブジェクトを正規化。
  - 全呼び出し箇所（例: `combat.js:61-125`, `input/overlay_controller.js:89-122`, `shop.js:15-115`, `state/player_state.js:338`）が `{ text, icon?, tone? }` 形式か、既にその形のオブジェクトを渡す。

---

## 成功判定との突合せ

| 成功判定 (GAME_DESIGEN.md) | 現状 | コメント |
| --- | --- | --- |
| `game_state.js` を 400 行未満に縮小 | **達成 (349 行)** | `data/enemies.js` 分離で実現。 |
| `input` 配下でモード別クラスの単体テストが可能 | **達成** | ルータが `input/index.js` に配置され、各コントローラは独立ファイルのまま。 |
| `drawAll()` 差し替えのみで描画を拡張できる | **達成** | renderer ファサードが描画順を集中管理。 |
| 敵スポーン/追跡ロジックがモジュール単体でテスト可能 & `Game.entities` から分離 | **達成** | 既存構成のまま維持。 |
| `pushMessage` が統一フォーマットで UI 崩れなし | **達成** | 正規化 + 全呼び出しで `{ text }` 形式を使用。 |

---

## 今後のフォローアップ

現時点で設計書からの機能的ギャップはありません。引き続き以下の軽微な確認を行うと安心です。

1. **動作確認**: ブラウザでゲームを起動し、フィールド ↔ 街 ↔ 洞窟の遷移・戦闘・ショップ/宿の利用を一通り試してデータ分離後も挙動が変わらないかチェックしてください。
2. **テスト計画**: `Game.messageLog` の新フォーマットが UI で期待通り表示されるか、描画順の変更（`drawAll`）に伴う回帰が無いかを目視確認してください。

追加の設計変更が入らない限り、リファクタリング設計書に対する未対応項目は **0** 件です。***
