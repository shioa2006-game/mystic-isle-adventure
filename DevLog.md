#１．Mystic Isle Adventure -現在の実装内容
---
## ゲームストーリー遷移の全体像

### 4つのメインフェーズ

```
PHASE 0: START (開始)
  ↓ 王様と会話してクエスト受注
  ↓ questGiven = true

PHASE 1: BLACKSMITH_RESCUED (鍛冶屋救出)
  ↓ 洞窟1でガーディアン2体撃破
  ↓ 鍛冶屋と会話して救出
  ↓ blacksmithRescued = true
  ↓ 力のハンマー入手
  ↓ hasHammer = true

PHASE 2: ORE_OBTAINED (聖鉱石入手)
  ↓ 力のハンマーで洞窟2の岩を破壊
  ↓ cave2Unlocked = true
  ↓ 洞窟2 2階の宝箱から聖鉱石入手
  ↓ hasOre = true

PHASE 3: HOLY_SWORD_CREATED (聖剣錬成)
  ↓ 商人から鉄の剣購入 (150G)
  ↓ 鍛冶屋で聖剣錬成 (鉄の剣 + 聖鉱石 → 聖剣)
  ↓ holySwordCreated = true
  ↓ 王様から聖盾授与
  ↓ hasHolyShield = true

PHASE 4: DRAGON_DEFEATED (竜討伐)
  ↓ 遺跡2階で竜と戦闘
  ↓ 竜を倒す
  ↓ dragonDefeated = true
  ↓
🎉 エンディング画面表示
```

### ゲームクリア条件

ゲームをクリアするには、以下の**3つの条件すべて**を満たす必要があります：

1. **聖剣を装備していること** ✅
   - これがないと竜にダメージを与えられない（ダメージ0）
   - 鍛冶屋で鉄の剣 + 聖鉱石を錬成して入手

2. **聖盾を装備していること** ✅
   - これがないと竜の攻撃が2倍のダメージになる
   - 王様から授与される

3. **遺跡2階で竜を倒すこと** ✅
   - 竜のステータス: HP 120-150 / ATK 19-22 / DEF 10-12
   - 倒すとエンディング画面が表示される

---

## 重要なフラグ遷移

| フラグ名 | 説明 | 初期値 | trueになる条件 | falseに戻る条件 |
|---------|------|--------|---------------|----------------|
| `questTalked` | 王様と会話した | false | 王様に初めて話しかけた時 | - |
| `questGiven` | クエスト受注 | false | 王様と会話後 | - |
| `blacksmithGuardians` | 倒したガーディアン | Set() | ガーディアンを倒すごとに追加 | - |
| `blacksmithFreed` | ガーディアンを全滅させた | false | 2体のガーディアンを倒した時 | 鍛冶屋救出完了時 |
| `blacksmithRescued` | 鍛冶屋救出完了 | false | 鍛冶屋に話しかけた時 | - |
| `hasHammer` | 力のハンマー所持 | false | 鍛冶屋から受け取った時 | 洞窟2入口で使用した時 |
| `cave2Unlocked` | 洞窟2開通 | false | 力のハンマーで岩を破壊した時 | - |
| `hasOre` | 聖鉱石所持 | false | 洞窟2 2階の宝箱から入手 | 聖剣錬成時に消費 |
| `holySwordCreated` | 聖剣錬成完了 | false | 鍛冶屋で聖剣を錬成した時 | - |
| `hasHolyShield` | 聖盾所持 | false | 王様から授与された時 | - |
| `dragonDefeated` | 竜撃破 | false | 竜を倒した時 | - |
| `cleared` | ゲームクリア | false | 竜を倒した時 | - |

---

## NPC会話一覧

### 王様（King）

| フェーズ | フラグ条件 | セリフ内容 | アクション |
|---------|-----------|-----------|-----------|
| **0: START** | `questTalked = false` | 王様: よく来た、若き冒険者よ。[>]<br>王様: 遺跡に恐ろしい竜が現れたのだ。[>]<br>王様: 倒すには伝説の聖剣と聖盾が必要だ。[>]<br>王様: だが鍛冶屋が行方不明で困っている。 | `questTalked = true`<br>`questGiven = true` |
| **1: BLACKSMITH_RESCUED** | `blacksmithRescued = true` | 王様: 鍛冶屋を助けてくれたそうだな。[>]<br>王様: 聖剣を鍛えるには聖鉱石が欠かせぬ。[>]<br>王様: 鍛冶屋と協力して手に入れてきてくれ。 | なし |
| **2: ORE_OBTAINED** | `hasOre = true` | 王様: 聖鉱石を見つけたのだな。[>]<br>王様: 早く鍛冶屋に届け、聖剣を完成させるのだ。 | なし |
| **3: HOLY_SWORD_CREATED** | `holySwordCreated = true`<br>`hasHolyShield = false` | 王様: おお、見事な聖剣だ！[>]<br>王様: 約束通り、聖盾を授けよう。[>]<br>王様: これで竜にも立ち向かえるはずだ。 | `hasHolyShield = true`<br>聖盾を授与 |
| **3_after_shield** | `holySwordCreated = true`<br>`hasHolyShield = true` | 王様: 聖剣と聖盾を手にしたな。[>]<br>王様: その力で竜を倒し、島を救ってくれ！ | なし |

### 鍛冶屋（Blacksmith）

| フェーズ | フラグ条件 | セリフ内容 | アクション |
|---------|-----------|-----------|-----------|
| **0: START**<br>（洞窟1 2階） | `blacksmithFreed = true`<br>`blacksmithRescued = false` | 鍛冶屋: 助けてくれて本当に感謝する！[>]<br>鍛冶屋: だが聖鉱石はここにはなかった…[>]<br>鍛冶屋: 俺は街へ戻ることにする。君も気をつけろ。 | `blacksmithRescued = true`<br>`blacksmithFreed = false`<br>鍛冶屋が街へ移動 |
| **1: BLACKSMITH_RESCUED**<br>（街） | `blacksmithRescued = true`<br>`hasHammer = false` | 鍛冶屋: 命の恩人だ。礼に力のハンマーを渡そう。[>]<br>鍛冶屋: 東の海岸に岩で塞がれた洞窟があっただろう。[>]<br>鍛冶屋: これなら岩を砕ける。聖鉱石はその奥に眠っているはずだ。 | `hasHammer = true`<br>力のハンマーを授与 |
| **1_after_hammer** | `blacksmithRescued = true`<br>`hasHammer = true` | 鍛冶屋: そのハンマーで東の海岸の岩を砕けるはずだ。[>]<br>鍛冶屋: 聖鉱石はその奥に眠っているはずだ。頼んだぞ。 | なし |
| **2: ORE_OBTAINED** | `hasOre = true`<br>`holySwordCreated = false` | 鍛冶屋: おお、これこそ聖鉱石だ！[>]<br>鍛冶屋: 聖剣を鍛えるには鉄の剣も必要だ。[>]<br>鍛冶屋: 商人から手に入れて持ってきてくれ。 | なし |
| **3: HOLY_SWORD_CREATED**<br>（錬成時） | `hasOre = true`<br>`holySwordCreated = false`<br>鉄の剣 + 聖鉱石を所持 | *(自動処理)* | `holySwordCreated = true`<br>`hasOre = false`<br>鉄の剣と聖鉱石を消費<br>聖剣を授与 |
| **3: HOLY_SWORD_CREATED**<br>（錬成後） | `holySwordCreated = true` | 鍛冶屋: 聖剣の出来栄えは完璧だ。[>]<br>鍛冶屋: 聖盾は王様に頼んで受け取ってくれ。[>]<br>鍛冶屋: 君なら必ず竜を倒せるはずだ。 | なし |

---

## ストーリーアイテムの流れ

### アイテム取得・消費フロー

```
力のハンマー (Power Hammer)
  入手: 鍛冶屋から授与 (PHASE 1)
    ↓
  使用: 洞窟2入口の岩を破壊 (PHASE 2)
    ↓
  消費: hasHammer = false, cave2Unlocked = true

聖鉱石 (Holy Ore)
  入手: 洞窟2 2階の宝箱 (PHASE 2)
    ↓
  使用: 鍛冶屋で聖剣錬成の素材 (PHASE 3)
    ↓
  消費: hasOre = false

鉄の剣 (Iron Sword)
  入手: 商人から購入 (150G)
    ↓
  使用: 鍛冶屋で聖剣錬成の素材 (PHASE 3)
    ↓
  消費: インベントリから削除

聖剣 (Holy Sword) - **装備必須**
  入手: 鍛冶屋が錬成 (鉄の剣 + 聖鉱石)
    ↓
  効果: ATK +10、竜へのダメージが可能に
    ↓
  用途: 竜との戦闘に必須（これがないとダメージ0）

聖盾 (Holy Shield) - **装備必須**
  入手: 王様から授与 (PHASE 3)
    ↓
  効果: DEF +10、竜からのダメージを軽減
    ↓
  用途: 竜との戦闘に必須（これがないとダメージ2倍）
```

---

## エリア遷移の流れ

### マップ構成

```
フィールド (FIELD)
├─ 街 (TOWN) ※安全地帯
│  ├─ 王様 (x:18, y:2)
│  ├─ 鍛冶屋 (x:21, y:2) ※救出後に移動
│  ├─ 神父 (x:15, y:2) ※セーブポイント
│  ├─ 商人 (x:13, y:11)
│  └─ 宿屋主人 (x:9, y:5)
│
├─ 洞窟1 1層 (CAVE)
│  └─ 洞窟1 2階 (CAVE_B2)
│     ├─ 鍛冶屋 (x:1, y:1) ※救出前の位置
│     └─ ガーディアン (SKELETON x2) ※鍛冶屋を囲む
│
├─ 洞窟2 1層 (CAVE2) ※要：力のハンマーで岩破壊
│  └─ 洞窟2 2階 (CAVE2_B2)
│     └─ 宝箱 (x:1, y:1) ※聖鉱石
│
└─ 遺跡1階 (RUINS)
   └─ 遺跡2階 (RUINS_B2)
      └─ 竜 (DRAGON) ※ボス戦
```

### 進入条件

| エリア | 進入条件 | 備考 |
|--------|---------|------|
| フィールド (FIELD) | なし | 初期スポーン地点 |
| 街 (TOWN) | なし | 安全地帯、敵なし |
| 洞窟1 1層 (CAVE) | なし | |
| 洞窟1 2階 (CAVE_B2) | なし | 鍛冶屋救出の場所 |
| 洞窟2 1層 (CAVE2) | **力のハンマー必須** | 岩を破壊する必要あり |
| 洞窟2 2階 (CAVE2_B2) | 洞窟2 1層から | 聖鉱石入手 |
| 遺跡1階 (RUINS) | なし | |
| 遺跡2階 (RUINS_B2) | なし | 竜との決戦の場所 |

---

## モンスター一覧

### フィールド (FIELD)

| 名前 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|------|---------|----|----|-----|-----|------|
| スライム (SLIME) | フィールド | 8-12 | 2-3 | 0 | 3-5 | 4-8 |
| コウモリ (BAT) | フィールド | 14-18 | 3-4 | 0-1 | 6-8 | 8-12 |
| クモ (SPIDER) | フィールド | 20-26 | 4-6 | 1-2 | 9-12 | 12-16 |

### 洞窟1 (CAVE, CAVE_B2)

| 名前 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|------|---------|----|----|-----|-----|------|
| ゴースト (GHOST) | 洞窟1 | 28-34 | 7-9 | 3-4 | 12-16 | 16-20 |
| ウルフ (WOLF) | 洞窟1 | 24-32 | 6-8 | 2-3 | 10-14 | 14-18 |
| スケルトン (SKELETON) | 洞窟1 | 32-40 | 7-9 | 3-4 | 14-18 | 18-22 |

**特殊**: スケルトン x2がガーディアンとして鍛冶屋を囲んでいる（洞窟1 2階）

### 洞窟2 (CAVE2, CAVE2_B2)

| 名前 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|------|---------|----|----|-----|-----|------|
| リザードマン (LIZARDMAN) | 洞窟2 | 48-56 | 10-12 | 3-4 | 20-26 | 24-30 |
| ヴァンパイア (VAMPIRE) | 洞窟2 | 42-52 | 9-11 | 3-4 | 18-24 | 22-28 |
| トロル (TROLL) | 洞窟2 | 56-68 | 11-14 | 4-5 | 24-32 | 28-36 |

### 遺跡 (RUINS, RUINS_B2)

| 名前 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|------|---------|----|----|-----|-----|------|
| ゴーレム (GOLEM) | 遺跡 | 85-100 | 14-17 | 7-9 | 40-50 | 42-50 |
| ダークナイト (DARK_KNIGHT) | 遺跡 | 90-105 | 15-18 | 8-10 | 45-55 | 48-60 |
| リーパー (REAPER) | 遺跡 | 95-110 | 16-20 | 9-11 | 50-60 | 52-65 |

### ボス

| 名前 | 出現場所 | HP | ATK | DEF | EXP | Gold | 備考 |
|------|---------|----|----|-----|-----|------|------|
| **ドラゴン (DRAGON)** | 遺跡2階 | 120-150 | 19-22 | 10-12 | 100-150 | 100-150 | **聖剣・聖盾必須** |

**ドラゴン戦の特殊仕様:**
- 聖剣がない → プレイヤーの攻撃ダメージ = 0（進行不可）
- 聖盾がない → 竜の攻撃ダメージ = 2倍または+5（実質不可能）
- 倒すとエンディング画面表示

---

## アイテム一覧

### 消費アイテム

| アイテム名 | 価格 | 効果 | 説明 |
|-----------|------|------|------|
| Food 10 | 10G | Food +10 | Foodを10回復 |
| Potion | 15G | HP +20 | HPを20回復 |

### 装備アイテム - 武器 (WEAPON)

| アイテム名 | 価格 | 効果 | 説明 |
|-----------|------|------|------|
| Wood Sword | 50G | ATK +2 | 木の剣 |
| Bronze Sword | 90G | ATK +4 | 青銅の剣 |
| Iron Sword | 150G | ATK +6 | 鉄の剣（聖剣錬成の素材） |
| **Holy Sword** | - | ATK +10 | **聖剣**（鍛冶屋が錬成、竜戦必須） |

### 装備アイテム - 盾 (SHIELD)

| アイテム名 | 価格 | 効果 | 説明 |
|-----------|------|------|------|
| Wood Shield | 45G | DEF +2 | 木の盾 |
| Bronze Shield | 75G | DEF +4 | 青銅の盾 |
| Iron Shield | 135G | DEF +6 | 鉄の盾 |
| **Holy Shield** | - | DEF +10 | **聖盾**（王様から授与、竜戦必須） |

### ストーリーアイテム (STORY)

| アイテム名 | 入手方法 | 用途 | 消費 |
|-----------|---------|------|------|
| Power Hammer | 鍛冶屋から授与 | 洞窟2入口の岩を破壊 | ✅ |
| Holy Ore | 洞窟2 2階の宝箱 | 聖剣錬成の素材 | ✅ |
| Ancient Key | *(未実装)* | 遺跡の扉を開く | - |

**注意**: Ancient Keyはデータ上存在しますが、現在のゲームでは使用されていません。

---

## 推奨プレイフロー

### 初期段階（Lv 1-5）
1. フィールドで敵と戦闘、レベル上げとGold稼ぎ
2. 商人で装備購入（Wood Sword + Wood Shield）
3. 王様に話しかけてクエスト受注

### 洞窟1攻略（Lv 5-8）
4. 洞窟1へ進入、敵と戦闘
5. 洞窟1 2階でガーディアン2体を倒す
6. 鍛冶屋に話しかけて救出
7. 街で鍛冶屋と会話、力のハンマー入手

### 洞窟2攻略（Lv 8-12）
8. 商人で強い装備購入（Bronze/Iron装備）
9. 洞窟2入口で力のハンマーを使用、岩を破壊
10. 洞窟2を攻略、2階の宝箱から聖鉱石入手

### 聖剣・聖盾入手（Lv 12-15）
11. 商人から鉄の剣購入（150G）
12. 鍛冶屋で聖剣錬成（鉄の剣 + 聖鉱石 → 聖剣）
13. 王様から聖盾授与

### 最終決戦（Lv 15+）
14. 聖剣と聖盾を装備
15. 遺跡2階で竜と戦闘
16. 竜を倒してゲームクリア！

---
# ２．Mystic Isle Adventure -今後の追加開発
---
## 新しいゲームフロー
---
### フェーズの流れ（物語ベース）

1. **START**

   - 王様から竜討伐クエスト受注（現行どおり）

2. **鍛冶屋救出（洞窟1）**

   - 洞窟1 B2 でガーディアン撃破 → 鍛冶屋救出 → 力のハンマー入手

3. **聖鉱石入手（洞窟2）**

   - 力のハンマーで洞窟2入口を開ける  
   - 洞窟2 B2 の宝箱から聖鉱石（Holy Ore）入手

4. **古代剣探索ミッション発生**

   - 聖鉱石を持って鍛冶屋と会話  
     - 「聖鉱石だけでは足りない。遺跡のどこかに眠る古代の剣が必要だ」
   - その後、王様と会話  
     - 「古代剣が眠る部屋は古代の鍵で封じられている」
     - **古代の鍵（Ancient Key）を授与**

5. **古代剣入手（遺跡2階）**

   - 遺跡1F → 遺跡2F  
   - 遺跡2F の **鍵付き扉** を Ancient Key で開く  
     - このとき **Ancient Key は消費される**  
     - 一度通過したあとは、扉は **常時オープン（以降は鍵なしで通過可能）**
   - 扉の先の部屋で固定スポーンのダークナイト3体を撃破  
   - 宝箱から **古代の剣（Ancient Sword）** 入手

6. **聖剣錬成（街の鍛冶屋）**

   - 聖鉱石 + Ancient Sword を鍛冶屋に渡す  
   - 聖剣（Holy Sword）を錬成（Ancient Sword / Holy Ore は消費）

7. **聖盾入手（王様）**

   - 聖剣完成後、王様から聖盾（Holy Shield）授与（現行どおり）

8. **最終決戦（遺跡3階）**

   - 遺跡2F のどこかにある階段から遺跡3Fへ  
   - 遺跡3F にドラゴン配置  
   - 遺跡1F〜3Fの出入りは常に自由だが、  
     - ドラゴンには「**聖剣なしダメージ0**」「**聖盾なしダメージ2倍**」の特別ルールがあるため、  
       実質的には **聖剣＋聖盾装備でドラゴン討伐 → エンディング** という進行になる。

---

## 追加開発概要：古代剣ミッション／遺跡拡張

聖剣錬成フローを

- 旧：聖鉱石 + 鉄の剣 → 聖剣
- 新：聖鉱石 + 古代の剣（Ancient Sword） → 聖剣

に変更し、これに合わせて「古代の剣探索ミッション」と「遺跡の拡張」を行う。

### 1. フラグ / フェーズ設計

- フェーズ構成に「古代剣入手前後」を切るためのフェーズを 1つ追加する。
  - 例）
    - 聖鉱石入手フェーズ
    - **古代の剣入手フェーズ（新規）**
    - 聖剣錬成フェーズ
- 古代剣入手を境に、NPC会話（鍛冶屋・王様）やイベント分岐を管理する。

※具体的なフェーズ名・IDは既存の実装に合わせて命名する。

---

### 2. 遺跡の拡張とギミック仕様

#### 2-1. 遺跡の階層構成

- 遺跡を 3階構成に変更する。
  - 遺跡1F：従来どおり（入り口フロア）
  - 遺跡2F：**古代剣の宝箱部屋を配置（新規）**
  - 遺跡3F：**ドラゴン戦フロア（ドラゴンの位置をここへ移動）**

マップの具体的なレイアウト（広さ・形・通路構造など）は、これまでどおり**エディタ上で手作業で作成**するため、DevLog では詳細定義しない。

#### 2-2. 古代剣の宝箱部屋と扉

- 遺跡2F に「古代の剣（Ancient Sword）」が入った宝箱のある部屋を用意する。
- この部屋には**鍵付きの扉**を設置し、以下の仕様とする：
  - 扉は **古代の鍵（Ancient Key）** を所持していないと開かない。
  - プレイヤーが Ancient Key を所持した状態で扉を通過したタイミングで、
    - **Ancient Key は消費（インベントリから削除）**する。
    - 一度通過したあとは、扉は **常時オープン扱い**とし、以降は鍵なしで通過できる。
      - 実装上は、扉通過時に専用フラグ（例：`ancientDoorOpened = true`）を立て、
        - true の場合は、マップ上で開いた状態（通行可能タイル）として扱う。

---

### 3. バトル・バランス：ダークナイト固定ガーディアン

- 古代剣の宝箱部屋の周囲に、**ダークナイト 3体**を配置する。
  - 役割：宝箱のガーディアン（中ボス的なポジション）
- 仕様は「既存のスケルトン・ガーディアン」と同様に扱う：
  - **特別なガーディアン扱い（中ボス的存在）**
  - **persistent（倒したら復活しない）**
    - 初回撃破時に専用フラグを立て、それ以降は再スポーンしない。
- プレイヤーが敗北してやり直す場合の扱いは、既存のガーディアン仕様に合わせる。

---

### 4. 古代の鍵（Ancient Key）の取得フロー

- 聖鉱石を入手したあと、以下の流れで古代剣ミッションが始まる：
  1. プレイヤーが聖鉱石を鍛冶屋に見せる。
     - 鍛冶屋から  
       - 「聖鉱石だけでは真の聖剣にはならない」  
       - 「遺跡のどこかに眠る古代の剣が必要だ」  
       といった説明を受ける。
  2. その後、王様のもとへ行く。
     - 王様から  
       - 「古代剣が眠る部屋は古代の鍵で封じられている」  
       と説明され、
       - **古代の鍵（Ancient Key）を入手**する。

- これにより、プレイヤーは「遺跡2Fの鍵付き扉を Ancient Key で開き、古代の剣を取りに行く」という明確なサブ目標を得る。

---

### 5. 進行制御・エッジケース仕様

- 遺跡1F〜3Fの**出入り自体はストーリー進行に関係なくいつでも自由**とする。
  - 聖鉱石や古代剣の有無にかかわらず、プレイヤーは遺跡3Fまで到達可能。
- ただし、ドラゴン戦には次の**特別ルール**を適用する：

  - **聖剣（Holy Sword）なし**
    - プレイヤーの攻撃ダメージは **0固定**（ダメージが通らない）。
  - **聖盾（Holy Shield）なし**
    - 受けるダメージが **2倍**（既存仕様を踏襲）。

- このため、ゲーム的には
  - 早い段階で遺跡3Fに挑むことは可能だが、
  - **聖剣と聖盾を揃えない限り、ドラゴンを実質的に撃破できない**
  という設計になっている。

→ 結果として、

- マップ上の自由度（どこでも行けるオープンさ）は維持しつつ、
- 聖鉱石 → 古代の剣 → 聖剣錬成 → 聖盾入手
  というメイン進行ルートを、ドラゴン戦の特殊ルールによって自然に強制する。

---
