# Mystic Isle Adventure

ブラウザで動作する探索型RPG。神秘的な島を舞台に、リソース管理とターン制戦闘を特徴とする2Dトップダウンアドベンチャーゲームです。

## 目次

- [ゲーム概要](#ゲーム概要)
- [プレイ方法](#プレイ方法)
- [プロジェクト構造](#プロジェクト構造)
- [操作方法](#操作方法)
- [ゲームシステム](#ゲームシステム)
- [技術スタック](#技術スタック)
- [開発情報](#開発情報)

## ゲーム概要

小さな島に漂着した冒険者となって、生存を図りながら島の謎を解く探索型RPGです。
島の西に現れた恐ろしい竜を討伐するため、失われた聖剣と聖盾を求めて冒険します。鍛冶屋を救出し、聖鉱石を発見し、伝説の武具を手に入れて、最終的に古代竜との決戦に挑みます。

**ゲーム仕様:**
- キャンバスサイズ: 800x600 (24x18グリッド、48pxタイル)
- シーン: 9つの相互接続されたマップ (FIELD, TOWN, CAVE, CAVE_B2, CAVE2, CAVE2_B2, RUINS, RUINS_B2, RUINS_B3)
- 言語: 日本語（すべてのUI/メッセージ）
- コード規模: 約4,297行のJavaScript（モジュール化された構造）
- ファイル数: 40+（設計書・アセット含む）

### 世界

ゲームは9つのシーンで構成されています：

- **FIELD（フィールド）** - 島全体。探索、戦闘、各施設への入口がある。遺跡が最終目標
- **TOWN（街）** - 安全地帯。商人、宿屋、王様、神父、鍛冶屋（救出後）がいる
- **CAVE（洞窟1 1層）** - 洞窟の第1階層。鍛冶屋の救出場所。階段で下層へ
- **CAVE_B2（洞窟1 地下2階）** - 洞窟1の最深部。鍛冶屋を救出する
- **CAVE2（洞窟2 1層）** - 岩で塞がれた洞窟。力のハンマーで開通。強力な敵が出現
- **CAVE2_B2（洞窟2 地下2階）** - 洞窟2の最深部。聖鉱石を入手できる
- **RUINS（遺跡1階）** - 古代遺跡の第1階層。強力な敵が出現
- **RUINS_B2（遺跡2階）** - 遺跡の中層。鍵付き扉や固定敵がいる
- **RUINS_B3（遺跡3階）** - 遺跡の最深部。古代竜との決戦場

## プレイ方法

以下のリンクからブラウザでアクセスするだけでプレイできます：

**🎮 ゲームリンク**: https://shioa2006-game.github.io/mystic-isle-adventure/

### 必要要件
- モダンブラウザ（Chrome、Firefox、Safari、Edge等）

## プロジェクト構造

```
mystic-isle-adventure/
├── index.html              # HTMLエントリポイント（50行）
├── style.css               # スタイルシート（42行）
├── sketch.js               # p5.js メインループ（56行）
│
├── config.js               # ゲーム設定（キャンバス、グリッドサイズなど）（16行）
├── constants.js            # 定数定義（タイルタイプ、アイテム定義など）（128行）
├── game_state.js           # ゲーム状態管理の中核（349行）
├── map_data.js             # マップ定義とシーン遷移（328行）
├── dialogue.js             # NPC対話システム（324行）
├── combat.js               # ターン制バトルシステム（172行）
├── shop.js                 # ショップ/商人インタラクション（178行）
├── inn.js                  # 宿屋システム（139行）
├── save_system.js          # セーブ・ロード機能（338行）
├── input.js                # 入力処理のメインコントローラー（121行）
├── utils.js                # ユーティリティ関数（A*パスファインディング含む）（160行）
│
├── state/                  # ゲーム状態管理モジュール
│   ├── player_state.js     # プレイヤー統計、インベントリ、装備管理（364行）
│   ├── occupancy.js        # グリッド占有システム（290行）
│   └── ui_state.js         # UI状態管理（オーバーレイ、選択など）（63行）
│
├── entities/               # エンティティシステム
│   ├── index.js            # エンティティシステムのエントリポイント（40行）
│   ├── entity_types.js     # 敵タイプ定義とステータス（73行）
│   ├── enemy_director.js   # 敵のスポーン、AI、移動管理（262行）
│   └── sprite_atlas.js     # スプライト管理（120行）
│
├── renderer/               # レンダリングシステム
│   ├── index.js            # レンダリングシステムのエントリポイント（20行）
│   ├── camera.js           # カメラシステム（20行）
│   ├── layout.js           # レイアウト定義（30行）
│   ├── map_layer.js        # マップ描画（83行）
│   ├── entity_layer.js     # エンティティ描画（103行）
│   ├── overlay_layer.js    # オーバーレイ描画（バトル、インベントリなど）（242行）
│   ├── ui_panel.js         # UIパネル描画（ステータス、メッセージ）（93行）
│   └── text_utils.js       # テキスト描画ユーティリティ（30行）
│
├── input/                  # 入力処理モジュール
│   ├── movement_controller.js    # 移動入力処理（154行）
│   ├── battle_input.js           # 戦闘入力処理（32行）
│   └── overlay_controller.js     # オーバーレイ入力処理（121行）
│
├── messages/               # メッセージシステム
│   └── log.js              # メッセージログ管理（44行）
│
├── data/                   # ゲームデータ
│   ├── enemies.js          # 敵能力値定義（114行）
│   ├── items.js            # アイテム定義（142行）
│   └── maps/               # マップデータ
│       ├── field.js        # フィールドマップ
│       ├── town.js         # 街マップ
│       ├── cave_b1.js      # 洞窟1 1層マップ
│       ├── cave_b2.js      # 洞窟1 地下2階マップ
│       ├── cave2_b1.js     # 洞窟2 1層マップ
│       ├── cave2_b2.js     # 洞窟2 地下2階マップ
│       ├── ruins_1f.js     # 遺跡1階マップ
│       ├── ruins_2f.js     # 遺跡2階マップ
│       └── ruins_3f.js     # 遺跡3階マップ
│
├── assets/                 # ゲームアセット
│   ├── tiles.png           # タイルセットスプライト（48x48/タイル）
│   ├── actors.png          # プレイヤー/NPC スプライト（6種類）
│   ├── enemies.png         # 敵スプライト（13種類）
│   ├── objects_interactable.png  # 宝箱など インタラクティブオブジェクト
│   └── dialogues.json      # NPC対話データ（王様、商人、宿屋、神父、鍛冶屋）
│
├── README.md               # このファイル
├── GAME_DESIGN.md          # 設計仕様書
├── Progress.md             # 開発進捗管理
├── Gap.md                  # 既知の課題
└── AGENTS.md               # 開発ガイドライン
```

### モジュール詳細

#### コアシステム
| ファイル | 行数 | 責務 |
|---------|------|------|
| `sketch.js` | 56 | p5.jsエントリポイント：アセット読み込み、キャンバス設定、メイン描画ループ |
| `config.js` | 16 | ゲーム設定：キャンバスサイズ、グリッドサイズ、タイルサイズ |
| `constants.js` | 128 | 定数定義：タイルタイプ、シーン定義、オーバーレイタイプ、レベルアップテーブル |
| `game_state.js` | 349 | ゲーム状態管理の中核：状態の初期化、更新、イベント処理の調整 |
| `map_data.js` | 328 | シーンのタイル定義、スポーン地点、入口/出口設定 |

#### 状態管理（state/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `state/player_state.js` | 364 | プレイヤー統計、インベントリ、装備、レベルアップ、アイテム取引 |
| `state/occupancy.js` | 290 | グリッド占有システム：エンティティ、宝箱、NPCの位置追跡 |
| `state/ui_state.js` | 63 | UI状態管理：オーバーレイ、選択、カーソル位置 |

#### エンティティシステム（entities/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `entities/enemy_director.js` | 262 | 敵のスポーン、AIパスファインディング、移動、ワールドとのインタラクション |
| `entities/entity_types.js` | 73 | 敵タイプ定義：ステータス、出現場所、ドロップアイテム |
| `entities/sprite_atlas.js` | 120 | スプライト管理：アトラスからのスプライト取得 |
| `entities/index.js` | 40 | エンティティシステムのエントリポイント |

#### レンダリングシステム（renderer/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `renderer/overlay_layer.js` | 242 | オーバーレイ描画：バトル画面、インベントリ、ショップ、クリア画面 |
| `renderer/entity_layer.js` | 103 | エンティティ描画：プレイヤー、敵、NPC |
| `renderer/ui_panel.js` | 93 | UIパネル描画：ステータス表示、メッセージログ |
| `renderer/map_layer.js` | 83 | マップタイル描画 |
| `renderer/layout.js` | 30 | レイアウト定義：パネル配置 |
| `renderer/text_utils.js` | 30 | テキスト描画ユーティリティ |
| `renderer/camera.js` | 20 | カメラシステム（将来の拡張用） |
| `renderer/index.js` | 20 | レンダリングシステムのエントリポイント |

#### 入力処理（input/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `input/movement_controller.js` | 154 | 移動入力処理：方向キー、NPC会話、イベントトリガー |
| `input/overlay_controller.js` | 121 | オーバーレイ入力処理：インベントリ、ショップナビゲーション |
| `input/battle_input.js` | 32 | 戦闘入力処理：攻撃、防御、逃走コマンド |
| `input.js` | 121 | 入力処理のメインコントローラー |

#### ゲームメカニクス
| ファイル | 行数 | 責務 |
|---------|------|------|
| `dialogue.js` | 324 | NPC対話システム：セリフデータ管理、会話セッション、段階的ストーリー進行、イベント連携 |
| `shop.js` | 178 | 商人とのやり取り：購入、売却、価格計算、インベントリチェック |
| `combat.js` | 172 | バトルメカニクス：ダメージ計算、ターンフロー、勝利/敗北処理、聖剣・聖盾チェック |
| `inn.js` | 139 | 宿屋主人とのやり取り：宿泊検証とHP回復 |
| `save_system.js` | 338 | セーブ・ロード機能：localStorageへの保存、スナップショット管理、神父との連携 |
| `utils.js` | 160 | ユーティリティ関数：A*パスファインディング（敵AI）、マンハッタン距離、乱数生成 |

#### データ定義（data/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `data/enemies.js` | 114 | 敵能力値定義：13種類の敵タイプのHP/ATK/DEF/EXP/Gold範囲 |
| `data/items.js` | 142 | アイテム定義：消費アイテム、装備品（剣4種、盾4種）、ストーリーアイテム |
| `data/maps/*.js` | - | マップデータ：8シーンのタイル配置（ASCII行配列） |

#### メッセージシステム（messages/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `messages/log.js` | 44 | メッセージログ管理：メッセージ追加、表示件数制限 |

### 初期プレイヤーステータス

```
HP: 30 | MaxHP: 30
ATK: 5 | DEF: 3
Level: 1 | EXP: 0
Food: 50 | Gold: 50
Inventory: 空（最大10スロット）
```

### リソース管理

生存のために以下のリソースを管理する必要があります：

- **HP（体力）** - 0になると神父の位置で復活し、GoldとFoodが半減する
- **Food（食料）** - フィールドや洞窟で2歩ごとに1消費（街では消費しない）。0になると歩くたびにHPが減少。**上限999**
- **Gold（所持金）** - 商人から物資を購入するために必要
- **装備** - 武器スロット1つと盾スロット1つ。装備中のアイテムは売却不可
  - **剣**: Wood Sword（ATK+2, 50G）、Bronze Sword（ATK+4, 90G）、Iron Sword（ATK+6, 150G）、Holy Sword（ATK+10）
  - **盾**: Wood Shield（DEF+2, 45G）、Bronze Shield（DEF+4, 75G）、Iron Shield（DEF+6, 135G）、Holy Shield（DEF+10）
  - **消費アイテム**: Potion（HP+20, 15G）、Food 10（Food+10, 10G）
- **インベントリ** - 最大10個までアイテムを所持可能（Food10は累積型で容量外）

## 操作方法

### コントロール一覧

| アクション | キー |
|-----------|-----|
| **移動** | 矢印キー（↑↓←→） |
| **会話/インタラクト** | T |
| **インベントリを開く** | I |
| **ステータス表示** | S |
| **戦闘: 攻撃** | A |
| **戦闘: 防御** | D |
| **戦闘: 逃げる** | R |
| **ショップ: 購入** | B |
| **ショップ: 売却** | S |
| **ショップ: 選択** | ↑↓ |
| **インベントリ: 使用** | U |
| **インベントリ: 詳細** | Enter |
| **宿屋: はい** | Y |
| **宿屋: いいえ** | N |
| **決定** | Enter |
| **キャンセル/閉じる** | Esc |

## ゲームシステム

### ゲームの進め方

**【序盤：依頼と状況把握】**
1. 島に漂着 → フィールドでスポーン
2. 神父と会話 → セーブ機能の説明を聞く
3. 王様と会話 → クエスト受注「遺跡の竜を倒せ」
4. 街の人々から情報収集 → 鍛冶屋が行方不明

**【第一章：鍛冶屋救出編】**
5. 商人で装備購入 → 木の剣・木の盾など
6. 洞窟1へ進入（1層→2層）
7. 洞窟1の2層で鍛冶屋を発見 → 魔物と戦闘
8. 鍛冶屋を救出成功 → 街へ帰還
9. 鍛冶屋と会話 → 「力のハンマー」入手

**【第二章：聖鉱石発見編】**
10. 東の洞窟2へ → 力のハンマーで岩を破壊
11. 洞窟2攻略（1層→2層）※強力な敵が出現
12. 洞窟2の2層の宝箱から「聖鉱石」入手

**【第三章：聖剣錬成編】**
13. 街へ帰還 → 鍛冶屋に聖鉱石を見せる
14. 商人から「鉄の剣」を購入
15. 鍛冶屋へ → 鉄の剣・聖鉱石で錬成
16. 「聖剣」完成！装備

**【第四章：聖盾授与編】**
17. 王様と会話 → 聖剣を見せる
18. 「聖盾」入手！装備
19. 神父でセーブ → 最終決戦前の準備

**【最終章：竜討伐編】**
20. 遺跡1層へ進入 ※最強の敵が出現
21. 遺跡2層へ進む → 最深部の王座の間へ
22. 古代竜と決戦 ※聖剣・聖盾が必要
23. 竜を倒す → エンディング画面表示
24. ゲームクリア！

**クリア条件:**
1. 鍛冶屋を救出して聖剣を錬成
2. 王様から聖盾を授与される
3. 聖剣と聖盾を装備して遺跡の古代竜を倒す
4. エンディング画面が表示されてクリア！

### 敵の種類と出現エリア

ゲームには13種類の敵が登場します：

### フィールドの敵（3種）
- **SLIME（スライム）** - 最も弱い敵。草原に出現
- **BAT（コウモリ）** - 木の近くに出現
- **SPIDER（クモ）** - 岩や山の近くに出現

### 洞窟1の敵（3種）
- **GHOST（ゴースト）** - 洞窟1に出現
- **WOLF（ウルフ）** - 洞窟1に出現
- **SKELETON（スケルトン）** - 洞窟1に出現

### 洞窟2の敵（3種）
- **LIZARDMAN（リザードマン）** - 洞窟2に出現。より強力
- **VAMPIRE（ヴァンパイア）** - 洞窟2に出現。より強力
- **TROLL（トロール）** - 洞窟2に出現。より強力

### 遺跡の敵（3種）
- **GOLEM（ゴーレム）** - 遺跡に出現。最強クラス
- **DARK_KNIGHT（ダークナイト）** - 遺跡に出現。最強クラス
- **REAPER（リーパー）** - 遺跡に出現。最強クラス

### ラスボス
- **DRAGON（古代竜）** - 遺跡3階の最深部に固定出現。聖剣・聖盾がないと倒せない

各エリアの敵は段階的に強力になります。装備を整えてから挑戦しましょう。

### 敵ステータステーブル

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| SLIME | FIELD | 8-12 | 2-3 | 0 | 3-5 | 4-8 |
| BAT | FIELD | 14-18 | 3-4 | 0-1 | 6-8 | 8-12 |
| SPIDER | FIELD | 20-26 | 4-6 | 1-2 | 9-12 | 12-16 |
| GHOST | CAVE1 | 28-34 | 7-9 | 3-4 | 12-16 | 16-20 |
| WOLF | CAVE1 | 24-32 | 6-8 | 2-3 | 10-14 | 14-18 |
| SKELETON | CAVE1 | 32-40 | 7-9 | 3-4 | 14-18 | 18-22 |
| LIZARDMAN | CAVE2 | 48-56 | 10-12 | 3-4 | 20-26 | 24-30 |
| VAMPIRE | CAVE2 | 42-52 | 9-11 | 3-4 | 18-24 | 22-28 |
| TROLL | CAVE2 | 56-68 | 11-14 | 4-5 | 24-32 | 28-36 |
| GOLEM | RUINS | 72-84 | 12-14 | 5-7 | 40-50 | 42-50 |
| DARK_KNIGHT | RUINS | 76-90 | 12-15 | 6-8 | 45-55 | 48-60 |
| REAPER | RUINS | 82-95 | 13-16 | 7-9 | 50-60 | 52-65 |
| DRAGON | RUINS_B3固定 | 120-150 | 19-22 | 10-12 | 100-150 | 100-150 |

※ステータスは出現時に範囲内でランダムに決定されます

## 戦闘システム

- 敵シンボルに接触するとターン制バトルが開始（プレイヤー先攻）
- **勝利時**：EXP獲得 + Gold獲得 + 1/2の確率でFood+10
- **敗北時**：神父の位置で復活、GoldとFoodが半減
- 逃走成功率は50%

### 古代竜との戦闘
- **聖剣が必要**：聖剣を装備していないと、竜にダメージを与えられない
- **聖盾が必要**：聖盾を装備していないと、竜の炎攻撃で2倍以上のダメージを受ける
- 聖剣と聖盾の両方を装備して挑むことが推奨される

### ダメージ計算

```
通常攻撃ダメージ = max(1, 攻撃者ATK + ランダム(0~2) - 防御者DEF)
防御時ダメージ = ceil(通常ダメージ / 2)
```

- **攻撃**：ATKとDEFの差に0~2のランダム値が加算され、最低1ダメージは保証
- **防御**：選択したターンのみ受けるダメージを50%軽減（切り上げ）。次ターンには効果が切れる
- **逃走**：50%の確率で成功。失敗すると敵の攻撃を受ける

## レベルアップシステム

経験値を獲得するとレベルアップします：
- **レベルアップ時の効果**：
  - MaxHP+3（毎回）
  - レベル4の倍数（LV4,8,12...）：ATK+1
  - レベル4で割って2余る（LV2,6,10...）：DEF+1
  - その他のレベル（LV3,5,7,9,11...）：ATK/DEF上昇なし
- **必要経験値の計算式**：`7 × レベル × (レベル - 1)`
  - LV2=14 / LV3=42 / LV4=84 / LV5=140 / LV6=210 / LV7=294 / LV8=392 / LV9=504 / LV10=630
- **最大レベル**: 99

## 高度なゲームメカニクス

### 敵AIシステム

敵（ドラゴンを除く）は**A*アルゴリズム**を使用してプレイヤーを追跡します：

- **追跡範囲**: プレイヤーとの距離が7タイル以内の場合のみ移動
- **経路探索**: 障害物を避けながら最短経路でプレイヤーに接近
- **移動制限**: 敵同士の衝突を回避し、移動可能なタイルのみを通過

### 敵のリスポーンシステム

- **リスポーン判定**: プレイヤーが15歩移動するごとに敵数を調整
- **FIELD**: 常時4-6体を維持
- **CAVE/CAVE_B2**: 各階層で常時2-4体を維持
- **CAVE2/CAVE2_B2**: 各階層で常時2-4体を維持
- **RUINS/RUINS_B2**: 各階層で常時2-4体を維持
- **スポーン条件**: プレイヤーから距離4以上離れた場所にのみ出現
- **ドラゴン**: RUINS_B3の固定位置に出現し、倒すとエンディングへ遷移

### 敵のスポーン位置選定

敵の出現場所はシーンと地形に基づいて決定されます：

**フィールド（FIELD）**:
- **木の近くまたは木上**: BAT または SPIDER（ランダム）
- **岩や山の近く**: SPIDER
- **その他の場所**: SLIME または BAT（ランダム）

**洞窟1（CAVE/CAVE_B2）**:
- GHOST、WOLF、SKELETON（ランダム）

**洞窟2（CAVE2/CAVE2_B2）**:
- LIZARDMAN、VAMPIRE、TROLL（ランダム）

**遺跡（RUINS/RUINS_B2）**:
- GOLEM、DARK_KNIGHT、REAPER（ランダム）

スポーン試行は最大200回まで行い、以下の条件を満たす場所を探します：
- プレイヤーから距離4以上
- 占有セル（敵、NPC、宝箱など）との重複なし
- 移動可能なタイル（水、山、岩、壁を除く）

### マップ遷移とスポーン地点

各シーン間の移動時にスポーン地点が変化します：

| 遷移 | トリガー | スポーン地点 |
|---|---|---|
| FIELD → TOWN | 街入口触接 | TOWN南扉下 |
| TOWN → FIELD (南) | 南扉触接 | FIELD街入口下1タイル |
| TOWN → FIELD (北) | 北扉触接 | FIELD街入口上1タイル |
| FIELD → CAVE | 洞窟1入口触接 | CAVE出口下1タイル |
| CAVE → FIELD | 洞窟出口触接 | FIELD洞窟入口下1タイル |
| CAVE → CAVE_B2 | 階段下触接 | CAVE_B2階段上の下1タイル |
| CAVE_B2 → CAVE | 階段上触接 | CAVE階段下の下1タイル |
| FIELD → CAVE2 | 洞窟2入口触接（力のハンマー必須） | CAVE2出口下1タイル |
| CAVE2 → FIELD | 洞窟2出口触接 | FIELD洞窟2入口下1タイル |
| CAVE2 → CAVE2_B2 | 階段下触接 | CAVE2_B2階段上の下1タイル |
| CAVE2_B2 → CAVE2 | 階段上触接 | CAVE2階段下の下1タイル |
| FIELD → RUINS | 遺跡入口触接 | RUINS出口下1タイル |
| RUINS → FIELD | 遺跡出口触接 | FIELD遺跡入口下1タイル |
| RUINS → RUINS_B2 | 階段下触接 | RUINS_B2階段上の下1タイル |
| RUINS_B2 → RUINS | 階段上触接 | RUINS階段下の下1タイル |
| RUINS_B2 → RUINS_B3 | 階段下触接 | RUINS_B3階段上の下1タイル |
| RUINS_B3 → RUINS_B2 | 階段上触接 | RUINS_B2階段下の下1タイル |

### マップ遷移図

```
FIELD（フィールド）
├─→ TOWN（街）
├─→ CAVE（洞窟1 1層）
│   └─→ CAVE_B2（洞窟1 地下2階）
├─→ CAVE2（洞窟2 1層）※力のハンマーで岩を破壊後
│   └─→ CAVE2_B2（洞窟2 地下2階）
└─→ RUINS（遺跡1階）
    └─→ RUINS_B2（遺跡2階）
        └─→ RUINS_B3（遺跡3階）
```

### メッセージシステム

画面右下のメッセージパネルには常に最新の4件のメッセージのみ表示されます：

- **表示位置**: 左下パネル（150px高さ）
- **表示件数**: 最新4件（自動改行により最大6行程度）
- **内容**: 戦闘結果、レベルアップ、アイテム入手、Food消費警告、NPC会話など

#### NPC会話システム

NPCとの会話はTキーで段階的に進行します：

- **進行マーカー**: 続きがあるセリフには `[>]` が表示される
- **会話終了**: 最後のセリフには `[>]` がなく、空行で終了を示す
- **クールダウン**: 会話終了後、1回移動するまで同じ会話を再開できない

**登場NPC:**
- **王様**: 竜討伐のクエストを与え、聖盾を授与する
- **商人**: 食料、ポーション、装備品を販売
- **宿屋**: 10Goldで休息、HP回復
- **神父**: セーブ機能を提供、死亡時のリスポーン地点
- **鍛冶屋**: 洞窟1で救出後、街に出現。聖剣を錬成し、力のハンマーを授与

**セリフ作成ガイドライン:**
- 1件のセリフ: **40文字以内**を推奨（最大50文字）
- 1回の会話: **3-4件**のセリフを推奨（空行含めて最大6行程度に収める）
- 最後以外のセリフに `[>]` マーカーを付ける

#### セーブ・ロード機能

神父に話しかけることでゲームを保存できます：

- **セーブ**: 神父に話しかけて「はい」を選択すると、現在の状態がlocalStorageに保存される
- **ロード**: タイトル画面の「続きから」ボタンで、保存した状態から再開できる
- **保存内容**: プレイヤーステータス、インベントリ、装備、ストーリーフラグ、現在位置、宝箱開封状態など
- **死亡時**: 神父の1マス下の位置で復活し、GoldとFoodが半減する

## 技術スタック

### コア技術

- **言語**: JavaScript ES6+
- **フレームワーク**: p5.js 1.6.0（Canvas-based graphics library）
- **レンダリング**: HTML5 Canvas 2D
- **アーキテクチャパターン**: IIFE（Immediately Invoked Function Expression）モジュールパターン

### アルゴリズム

- **A*パスファインディング**: 敵の追跡AI（`utils.js`）
- **マンハッタン距離**: 衝突・近接判定
- **乱数生成**: 敵スポーン、戦闘ダメージ計算

### アーキテクチャ設計

- **モジュール設計**: フォルダベースのモジュール分割でコードの保守性と可読性を向上
  - `state/`: 状態管理の分離（プレイヤー、占有、UI）
  - `entities/`: エンティティシステムの独立
  - `renderer/`: レンダリングパイプラインの層別化
  - `input/`: 入力処理のコンテキスト別分割
  - `messages/`: メッセージシステムの独立
- **中央集権型ステート管理**: 単一の`Game.state`オブジェクトで状態管理
- **イベント駆動**: タイルイベント解決（ワープ、宝箱、バトル）
- **対話システム**: JSON駆動のNPC会話とストーリー進行管理
- **占有グリッド**: 24x18グリッドで各タイルの占有状況を追跡
- **レイヤーベースレンダリング**: FLOOR → DECOR → STATIC → NPC → ENEMY → PLAYER

### ゲーム設定

```javascript
config = {
  canvasWidth: 800,
  canvasHeight: 600,
  tileSize: 48,
  gridWidth: 24,
  gridHeight: 18,
}
```

### タイルタイプ

15種類のタイルタイプ：
- **地形**: GRASS（草）, ROAD（道路）, WATER（水）, MOUNTAIN（山）, ROCK（岩）, TREE（木）
- **建造物**: WALL（壁）, DOOR（扉）, FLOOR_BUILD（建物床）, FLOOR_CAVE（洞窟床）
- **イベント**: ENTRANCE_TOWN（街入口）, ENTRANCE_CAVE（洞窟入口）, STAIRS_UP（階段上）, STAIRS_DOWN（階段下）, RUINS（遺跡）

### アセット

```javascript
// sketch.js preload()で読み込み
- tiles.png (48x48 sprites, 8列のタイルセット)
- actors.png (プレイヤー、商人、宿屋主人)
- enemies.png (7種類の敵)
- objects_interactable.png (宝箱など)
- dialogues.json (NPC対話データ)
```

## 開発情報

### プロジェクトステータス

**開発段階**: フルゲーム完成、追加開発完了、エンディングまで実装済み

**最近の改善**:
- **追加開発完了**（GAME_DESIGN.md準拠）:
  - セーブ・ロード機能（神父NPC、localStorage連携）
  - 新マップ4種追加（洞窟2系、遺跡系）
  - 新敵6種追加（WOLF、SKELETON、LIZARDMAN、GOLEM、DARK_KNIGHT、REAPER）
  - 装備拡張（剣4種、盾4種、聖剣・聖盾システム）
  - 鍛冶屋NPC追加（救出イベント、聖剣錬成）
  - 神父NPC追加（セーブポイント、リスポーン地点）
  - ストーリーフラグ管理（5段階のフェーズ進行）
  - 古代竜ボス戦（聖剣・聖盾必須）
  - エンディング画面実装
  - 力のハンマーによる岩破壊イベント
- 全モジュールのリファクタリングによるコード品質向上（game_state.js: 420行 → 349行）
- フォルダベースのモジュール設計による保守性向上
  - `state/`: プレイヤー状態、占有システム、UI状態を分離
  - `entities/`: エンティティシステムの独立
  - `renderer/`: レンダリングパイプラインの層別化
  - `input/`: 入力処理のコンテキスト別分割（移動、戦闘、オーバーレイ）
  - `messages/`: メッセージシステムの独立
  - `data/`: ゲームデータの統合（敵、アイテム、マップ）
- エンティティ/イベントインタラクションのバグ修正
- 日本語UI/メッセージの標準化
- 占有システムの信頼性向上のためのオーバーホール
- A*パスファインディングによる敵AIの実装
- マップを8シーンに拡張（FIELD、TOWN、CAVE系×2、CAVE2系×2、RUINS系×2）

**既知の課題**: なし（Gap.mdはすべて解決済み）

**技術的成果**:
- コード総行数: 4,297行（モジュール化と最適化により高い保守性を実現）
- リファクタリング完了率: 100%
- 単体テスト可能な設計: 各モジュールが独立して動作可能

### 技術ハイライト

**強み:**
- **フォルダベースのモジュール設計**: 機能別にファイルを分割し、保守性と可読性を大幅に向上
- **A*パスファインディング**: 知的な敵の挙動による戦略的なゲームプレイ
- **遅延占有グリッド再構築**: フレームごとのオーバーヘッド削減による高いパフォーマンス
- **単一場所での包括的なステート管理**: `Game.state`による一貫した状態管理
- **日本語ローカライゼーション**: 日本人プレイヤーにフレンドリーなUI/メッセージ

**注目すべき技術的特徴:**
- **マンハッタン距離による高速近接チェック**: 効率的な衝突判定
- **レイヤーベースレンダリング**: 視覚的クリッピング防止による美しい描画
- **メッセージ管理のためのイベントキュー**: ログの効率的な表示
- **スプライトアトラスシステム**: 画像管理の最適化
- **パラメータ化可能な敵スポーン挙動**: 地形に応じた敵の出現
- **責務分離設計**: state/、entities/、renderer/、input/フォルダによる明確な責務分離

---

**楽しいゲームプレイを！** 🎮
