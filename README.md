# Mystic Isle Adventure

ブラウザで動作する探索型RPG。神秘的な島を舞台に、リソース管理とターン制戦闘を特徴とする2Dトップダウンアドベンチャーゲームです。

## 目次

- [ゲーム概要](#ゲーム概要)
- [プレイ方法](#プレイ方法)
- [プロジェクト構造](#プロジェクト構造)
- [操作方法](#操作方法)
- [ゲームシステム](#ゲームシステム)
- [技術スタック](#技術スタック)
- [開発情報](#開発情報)

## ゲーム概要

小さな島に漂着した冒険者（🧝）となって、生存を図りながら島の謎を解く探索型RPGです。
フィールドを探索し、敵と戦い、商人から物資を補給しながら、最終的に洞窟で **Ancient Key** を入手し、遺跡の門を開いて中枢に到達することが目標です。

**ゲーム仕様:**
- キャンバスサイズ: 800x600 (24x18グリッド、48pxタイル)
- シーン: 3つの相互接続されたマップ (FIELD, TOWN, CAVE)
- 言語: 日本語（すべてのUI/メッセージ）
- コード規模: 約4,220行のJavaScript（モジュール化された構造）

### 世界

ゲームは3つのシーンで構成されています：

- **FIELD（フィールド）** - 島全体。探索、戦闘、各施設への入口がある
- **TOWN（街）** - 安全地帯。商人🧙‍♂️がいて、物資の売買ができる。宿屋🛏️で休息も可能
- **CAVE（洞窟）** - ミニ区画。宝箱に重要なアイテムがある。強力な敵が出現

## プレイ方法

以下のリンクからブラウザでアクセスするだけでプレイできます：

**🎮 ゲームリンク**: https://shioa2006-game.github.io/mystic-isle-adventure/

### 必要要件
- モダンブラウザ（Chrome、Firefox、Safari、Edge等）

## プロジェクト構造

```
mystic-isle-adventure/
├── index.html              # HTMLエントリポイント（50行）
├── style.css               # スタイルシート（42行）
├── sketch.js               # p5.js メインループ（56行）
│
├── config.js               # ゲーム設定（キャンバス、グリッドサイズなど）（16行）
├── constants.js            # 定数定義（タイルタイプ、アイテム定義など）（144行）
├── game_state.js           # ゲーム状態管理の中核（420行）
├── map_data.js             # マップ定義とシーン遷移（328行）
├── dialogue.js             # NPC対話システム（240行）
├── combat.js               # ターン制バトルシステム（147行）
├── shop.js                 # ショップ/商人インタラクション（173行）
├── inn.js                  # 宿屋システム（139行）
├── input.js                # 入力処理のメインコントローラー（121行）
├── utils.js                # ユーティリティ関数（A*パスファインディング含む）（160行）
│
├── state/                  # ゲーム状態管理モジュール
│   ├── player_state.js     # プレイヤー統計、インベントリ、装備管理（364行）
│   ├── occupancy.js        # グリッド占有システム（290行）
│   └── ui_state.js         # UI状態管理（オーバーレイ、選択など）（63行）
│
├── entities/               # エンティティシステム
│   ├── index.js            # エンティティシステムのエントリポイント（40行）
│   ├── entity_types.js     # 敵タイプ定義とステータス（73行）
│   ├── enemy_director.js   # 敵のスポーン、AI、移動管理（262行）
│   └── sprite_atlas.js     # スプライト管理（120行）
│
├── renderer/               # レンダリングシステム
│   ├── index.js            # レンダリングシステムのエントリポイント（20行）
│   ├── camera.js           # カメラシステム（20行）
│   ├── layout.js           # レイアウト定義（30行）
│   ├── map_layer.js        # マップ描画（83行）
│   ├── entity_layer.js     # エンティティ描画（103行）
│   ├── overlay_layer.js    # オーバーレイ描画（バトル、インベントリなど）（242行）
│   ├── ui_panel.js         # UIパネル描画（ステータス、メッセージ）（93行）
│   └── text_utils.js       # テキスト描画ユーティリティ（30行）
│
├── input/                  # 入力処理モジュール
│   ├── movement_controller.js    # 移動入力処理（154行）
│   ├── battle_input.js           # 戦闘入力処理（32行）
│   └── overlay_controller.js     # オーバーレイ入力処理（121行）
│
├── messages/               # メッセージシステム
│   └── log.js              # メッセージログ管理（44行）
│
├── assets/                 # ゲームアセット
│   ├── tiles.png           # タイルセットスプライト（48x48/タイル）
│   ├── actors.png          # プレイヤー/NPC スプライト
│   ├── enemies.png         # 敵スプライト（7種類）
│   ├── objects_interactable.png  # 宝箱など インタラクティブオブジェクト
│   └── dialogues.json      # NPC対話データ
│
├── README.md               # このファイル
├── GAME_DESIGN.md          # 設計仕様書
├── Progress.md             # 開発進捗管理
├── Gap.md                  # 既知の課題
└── AGENTS.md               # 開発ガイドライン
```

### モジュール詳細

#### コアシステム
| ファイル | 行数 | 責務 |
|---------|------|------|
| `sketch.js` | 56 | p5.jsエントリポイント：アセット読み込み、キャンバス設定、メイン描画ループ |
| `config.js` | 16 | ゲーム設定：キャンバスサイズ、グリッドサイズ、タイルサイズ |
| `constants.js` | 144 | 定数定義：タイルタイプ、アイテム定義、レベルアップテーブル |
| `game_state.js` | 420 | ゲーム状態管理の中核：状態の初期化、更新、イベント処理の調整 |
| `map_data.js` | 328 | 3シーンのタイル定義、スポーン地点、入口/出口設定 |

#### 状態管理（state/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `state/player_state.js` | 364 | プレイヤー統計、インベントリ、装備、レベルアップ、アイテム取引 |
| `state/occupancy.js` | 290 | グリッド占有システム：エンティティ、宝箱、NPCの位置追跡 |
| `state/ui_state.js` | 63 | UI状態管理：オーバーレイ、選択、カーソル位置 |

#### エンティティシステム（entities/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `entities/enemy_director.js` | 262 | 敵のスポーン、AIパスファインディング、移動、ワールドとのインタラクション |
| `entities/entity_types.js` | 73 | 敵タイプ定義：ステータス、出現場所、ドロップアイテム |
| `entities/sprite_atlas.js` | 120 | スプライト管理：アトラスからのスプライト取得 |
| `entities/index.js` | 40 | エンティティシステムのエントリポイント |

#### レンダリングシステム（renderer/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `renderer/overlay_layer.js` | 242 | オーバーレイ描画：バトル画面、インベントリ、ショップ、クリア画面 |
| `renderer/entity_layer.js` | 103 | エンティティ描画：プレイヤー、敵、NPC |
| `renderer/ui_panel.js` | 93 | UIパネル描画：ステータス表示、メッセージログ |
| `renderer/map_layer.js` | 83 | マップタイル描画 |
| `renderer/layout.js` | 30 | レイアウト定義：パネル配置 |
| `renderer/text_utils.js` | 30 | テキスト描画ユーティリティ |
| `renderer/camera.js` | 20 | カメラシステム（将来の拡張用） |
| `renderer/index.js` | 20 | レンダリングシステムのエントリポイント |

#### 入力処理（input/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `input/movement_controller.js` | 154 | 移動入力処理：方向キー、NPC会話、イベントトリガー |
| `input/overlay_controller.js` | 121 | オーバーレイ入力処理：インベントリ、ショップナビゲーション |
| `input/battle_input.js` | 32 | 戦闘入力処理：攻撃、防御、逃走コマンド |
| `input.js` | 121 | 入力処理のメインコントローラー |

#### ゲームメカニクス
| ファイル | 行数 | 責務 |
|---------|------|------|
| `dialogue.js` | 240 | NPC対話システム：セリフデータ管理、会話セッション、段階的ストーリー進行 |
| `shop.js` | 173 | 商人とのやり取り：購入、売却、価格計算、インベントリチェック |
| `combat.js` | 147 | バトルメカニクス：ダメージ計算、ターンフロー、勝利/敗北処理 |
| `inn.js` | 139 | 宿屋主人とのやり取り：宿泊検証とHP回復 |
| `utils.js` | 160 | ユーティリティ関数：A*パスファインディング、距離計算、乱数生成 |

#### メッセージシステム（messages/）
| ファイル | 行数 | 責務 |
|---------|------|------|
| `messages/log.js` | 44 | メッセージログ管理：メッセージ追加、表示件数制限 |

### 初期プレイヤーステータス

```
HP: 30 | MaxHP: 30
ATK: 5 | DEF: 3
Level: 1 | EXP: 0
Food: 50 | Gold: 50
Inventory: 空（最大6スロット）
```

### リソース管理

生存のために以下のリソースを管理する必要があります：

- **HP（体力）** - 0になると安全地帯に戻され、HPが全回復する
- **Food（食料）** - フィールドや洞窟で2歩ごとに1消費（街では消費しない）。0になると歩くたびにHPが減少。**上限999**
- **Gold（所持金）** - 商人から物資を購入するために必要
- **装備** - 武器スロット1つと盾スロット1つ。装備中のアイテムは売却不可
  - **Bronze Sword**（ATK+2） - 武器スロット
  - **Wood Shield**（DEF+2） - 盾スロット
- **インベントリ** - 最大6個までアイテムを所持可能（Food10は累積型で容量外）

## 操作方法

### コントロール一覧

| アクション | キー |
|-----------|-----|
| **移動** | 矢印キー（↑↓←→） |
| **会話/インタラクト** | T |
| **インベントリを開く** | I |
| **ステータス表示** | S |
| **戦闘: 攻撃** | A |
| **戦闘: 防御** | D |
| **戦闘: 逃げる** | R |
| **ショップ: 購入** | B |
| **ショップ: 売却** | S |
| **ショップ: 選択** | ↑↓ |
| **インベントリ: 使用** | U |
| **インベントリ: 詳細** | Enter |
| **宿屋: はい** | Y |
| **宿屋: いいえ** | N |
| **決定** | Enter |
| **キャンセル/閉じる** | Esc |

## ゲームシステム

### ゲームの進め方

1. フィールドを探索し、敵を倒して経験値と金を獲得
2. 街（🏘️）に入り、商人から食料やポーション、装備を購入
3. 宿屋主人（🛏️）に話しかけて10Goldで休息し、HPを回復
4. 食料を管理しながら洞窟（入口🕳️ / 出口🪜）を探索
5. 洞窟の宝箱（📦）から **Ancient Key** を入手
6. 鍵を持って遺跡（🏛️）に到達するとクリア

**クリア条件:**
1. 洞窟内の宝箱（x:10, y:8）を開いて **Ancient Key** を入手
2. Ancient Keyを所持した状態でフィールドの遺跡（🏛️）に接触
3. ゲームクリア！

### 敵の種類と出現エリア

ゲームには7種類の敵が登場します：

### フィールドの敵
- **🫠 SLIME（スライム）** - 最も弱い敵。草原に出現
- **🦇 BAT（コウモリ）** - 木の近くに出現
- **🕷 SPIDER（蜘蛛）** - 岩や山の近くに出現
- **🐉 DRAGON（ドラゴン）** - 遺跡の守護者として固定出現。倒すと再出現しない

### 洞窟の敵
- **👻 GHOST（ゴースト）** - 洞窟に出現
- **🧛‍♂️ VAMPIRE（ヴァンパイア）** - 洞窟に出現
- **🧌 TROLL（トロール）** - 洞窟に出現

洞窟の敵はフィールドよりも強力です。装備を整えてから挑戦しましょう。

### 敵ステータステーブル

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| SLIME | FIELD | 8-12 | 2-3 | 0 | 3-5 | 4-8 |
| BAT | FIELD | 14-18 | 3-4 | 0-1 | 6-8 | 8-12 |
| SPIDER | FIELD | 20-26 | 4-6 | 1-2 | 9-12 | 12-16 |
| GHOST | CAVE | 28-34 | 6-7 | 2-3 | 12-16 | 16-20 |
| VAMPIRE | CAVE | 36-44 | 7-9 | 3-4 | 18-24 | 22-28 |
| TROLL | CAVE | 48-58 | 9-11 | 4-5 | 24-32 | 28-36 |
| DRAGON | FIELD固定 | 60-80 | 9-11 | 4-5 | 30-40 | 35-50 |

※ステータスは出現時に範囲内でランダムに決定されます

## 戦闘システム

- 敵シンボルに接触するとターン制バトルが開始（プレイヤー先攻）
- **勝利時**：EXP獲得 + Gold獲得 + HP+3回復
- **敗北時**：安全地帯に戻り、HP全回復（Gold等は失わない）
- 逃走成功率は50%

### ダメージ計算

```
通常攻撃ダメージ = max(1, 攻撃者ATK + ランダム(0~2) - 防御者DEF)
防御時ダメージ = ceil(通常ダメージ / 2)
```

- **攻撃**：ATKとDEFの差に0~2のランダム値が加算され、最低1ダメージは保証
- **防御**：選択したターンのみ受けるダメージを50%軽減（切り上げ）。次ターンには効果が切れる
- **逃走**：50%の確率で成功。失敗すると敵の攻撃を受ける

## レベルアップシステム

経験値を獲得するとレベルアップします：
- **レベルアップ時の効果**：MaxHP+5、ATK+1、DEF+1、HP+5回復
- **必要経験値**：LV2=10 / LV3=30 / LV4=60 / LV5=100 / LV6=150 / LV7=210 / LV8=280 / LV9=360 / LV10=440

## 高度なゲームメカニクス

### 敵AIシステム

敵（ドラゴンを除く）は**A*アルゴリズム**を使用してプレイヤーを追跡します：

- **追跡範囲**: プレイヤーとの距離が7タイル以内の場合のみ移動
- **経路探索**: 障害物を避けながら最短経路でプレイヤーに接近
- **移動制限**: 敵同士の衝突を回避し、移動可能なタイルのみを通過

### 敵のリスポーンシステム

- **リスポーン判定**: プレイヤーが20歩移動するごとに敵数を調整
- **FIELD**: 常時3-5体を維持（ドラゴンは別カウント）
- **CAVE**: 常時2-4体を維持
- **スポーン条件**: プレイヤーから距離4以上離れた場所にのみ出現
- **ドラゴン**: 固定位置に出現し、倒すと再出現しない（`dragonDefeated`フラグ）

### 敵のスポーン位置選定

敵の出現場所は地形に基づいて決定されます：

- **木の近くまたは木上**: BAT または SPIDER（ランダム）
- **岩や山の近く**: SPIDER
- **その他の場所**: SLIME または BAT（ランダム）
- **洞窟**: GHOST、VAMPIRE、TROLL（ランダム）

スポーン試行は最大200回まで行い、以下の条件を満たす場所を探します：
- プレイヤーから距離4以上
- 占有セル（敵、NPC、宝箱など）との重複なし
- 移動可能なタイル（水、山、岩、壁を除く）

### マップ遷移とスポーン地点

各シーン間の移動時にスポーン地点が変化します：

| 遷移 | トリガー | スポーン地点 |
|---|---|---|
| FIELD → TOWN | 街入口触接 | TOWN南扉下 |
| TOWN → FIELD (南) | 南扉触接 | FIELD街入口下1タイル |
| TOWN → FIELD (北) | 北扉触接 | FIELD街入口上1タイル |
| FIELD → CAVE | 洞窟入口触接 | CAVE出口下1タイル |
| CAVE → FIELD | 洞窟出口触接 | FIELD洞窟入口下1タイル |

### メッセージシステム

画面右下のメッセージパネルには常に最新の4件のメッセージのみ表示されます：

- **表示位置**: 左下パネル（150px高さ）
- **表示件数**: 最新4件（自動改行により最大6行程度）
- **内容**: 戦闘結果、レベルアップ、アイテム入手、Food消費警告、NPC会話など

#### NPC会話システム

NPCとの会話はTキーで段階的に進行します：

- **進行マーカー**: 続きがあるセリフには `[>]` が表示される
- **会話終了**: 最後のセリフには `[>]` がなく、空行で終了を示す
- **クールダウン**: 会話終了後、1回移動するまで同じ会話を再開できない

**セリフ作成ガイドライン:**
- 1件のセリフ: **40文字以内**を推奨（最大50文字）
- 1回の会話: **3-4件**のセリフを推奨（空行含めて最大6行程度に収める）
- 最後以外のセリフに `[>]` マーカーを付ける

## 技術スタック

### コア技術

- **言語**: JavaScript ES6+
- **フレームワーク**: p5.js 1.6.0（Canvas-based graphics library）
- **レンダリング**: HTML5 Canvas 2D
- **アーキテクチャパターン**: IIFE（Immediately Invoked Function Expression）モジュールパターン

### アルゴリズム

- **A*パスファインディング**: 敵の追跡AI（`utils.js`）
- **マンハッタン距離**: 衝突・近接判定
- **乱数生成**: 敵スポーン、戦闘ダメージ計算

### アーキテクチャ設計

- **モジュール設計**: フォルダベースのモジュール分割でコードの保守性と可読性を向上
  - `state/`: 状態管理の分離（プレイヤー、占有、UI）
  - `entities/`: エンティティシステムの独立
  - `renderer/`: レンダリングパイプラインの層別化
  - `input/`: 入力処理のコンテキスト別分割
  - `messages/`: メッセージシステムの独立
- **中央集権型ステート管理**: 単一の`Game.state`オブジェクトで状態管理
- **イベント駆動**: タイルイベント解決（ワープ、宝箱、バトル）
- **対話システム**: JSON駆動のNPC会話とストーリー進行管理
- **占有グリッド**: 24x18グリッドで各タイルの占有状況を追跡
- **レイヤーベースレンダリング**: FLOOR → DECOR → STATIC → NPC → ENEMY → PLAYER

### ゲーム設定

```javascript
config = {
  canvasWidth: 800,
  canvasHeight: 600,
  tileSize: 48,
  gridWidth: 24,
  gridHeight: 18,
}
```

### タイルタイプ

15種類のタイルタイプ：
- **地形**: GRASS, WATER, MOUNTAIN, ROCK, TREE
- **建造物**: WALL, DOOR, FLOOR_BUILD, FLOOR_CAVE
- **イベント**: ENTRANCE_TOWN, ENTRANCE_CAVE, STAIRS_UP, RUINS

### アセット

```javascript
// sketch.js preload()で読み込み
- tiles.png (48x48 sprites, 8列のタイルセット)
- actors.png (プレイヤー、商人、宿屋主人)
- enemies.png (7種類の敵)
- objects_interactable.png (宝箱など)
- dialogues.json (NPC対話データ)
```

## 開発情報

### プロジェクトステータス

**開発段階**: MVP完成、コアゲームループ実装済み

**最近の改善** (Progress.mdより):
- 全モジュールのリファクタリングによるコード品質向上
- エンティティ/イベントインタラクションのバグ修正
- 日本語UI/メッセージの標準化
- 占有システムの信頼性向上のためのオーバーホール

**既知の課題**: なし（Gap.mdは空）

### 技術ハイライト

**強み:**
- **フォルダベースのモジュール設計**: 機能別にファイルを分割し、保守性と可読性を大幅に向上
- **A*パスファインディング**: 知的な敵の挙動による戦略的なゲームプレイ
- **遅延占有グリッド再構築**: フレームごとのオーバーヘッド削減による高いパフォーマンス
- **単一場所での包括的なステート管理**: `Game.state`による一貫した状態管理
- **日本語ローカライゼーション**: 日本人プレイヤーにフレンドリーなUI/メッセージ

**注目すべき技術的特徴:**
- **マンハッタン距離による高速近接チェック**: 効率的な衝突判定
- **レイヤーベースレンダリング**: 視覚的クリッピング防止による美しい描画
- **メッセージ管理のためのイベントキュー**: ログの効率的な表示
- **スプライトアトラスシステム**: 画像管理の最適化
- **パラメータ化可能な敵スポーン挙動**: 地形に応じた敵の出現
- **責務分離設計**: state/、entities/、renderer/、input/フォルダによる明確な責務分離

---

**楽しいゲームプレイを！** 🎮
