# ゲームフローとNPCセリフ整理

## ゲーム進行フェーズ

ゲームは6つのストーリーフェーズで進行します：

### フェーズ 0: START（開始）
**状態**: ゲーム開始直後
**条件**: なし
**目標**: 王様からクエストを受け、鍛冶屋を救出する

### フェーズ 1: BLACKSMITH_RESCUED（鍛冶屋救出）
**状態**: 鍛冶屋を洞窟1から救出完了
**条件**: `blacksmithRescued = true`
**目標**: 力のハンマーを入手し、東の洞窟2で聖鉱石を探す

### フェーズ 2: ORE_OBTAINED（聖鉱石入手）
**状態**: 洞窟2の地下2階で聖鉱石を入手
**条件**: `hasOre = true`
**目標**: 王様から古代の鍵を受け取り、遺跡の鍵付き扉を開ける

### フェーズ 3: ANCIENT_SWORD_READY（古代の剣入手）
**状態**: 遺跡2階で古代の剣を入手
**条件**: `hasAncientSword = true`
**目標**: 鍛冶屋に古代の剣と聖鉱石を渡して聖剣を錬成

### フェーズ 4: HOLY_SWORD_CREATED（聖剣完成）
**状態**: 聖剣の錬成が完了
**条件**: `holySwordCreated = true`
**目標**: 王様から聖盾を受け取り、遺跡の竜に挑む

### フェーズ 5: DRAGON_DEFEATED（竜討伐）
**状態**: 古代竜を倒した
**条件**: `dragonDefeated = true`
**結果**: エンディング画面表示

---

## 王様のセリフ

### フェーズ 0: START
```
王様: よく来た、若き冒険者よ。[>]
王様: 遺跡に恐ろしい竜が現れたのだ。[>]
王様: 倒すには伝説の聖剣と聖盾が必要だ。まず鍛冶屋を探し出してくれ。
```
**イベント**: 会話終了時に `questTalked` と `questGiven` フラグが立つ

### フェーズ 1: BLACKSMITH_RESCUED
```
王様: 鍛冶屋を助けてくれたそうだな。[>]
王様: 聖剣を鍛えるには聖鉱石が欠かせぬ。東の洞窟に眠っているはずだ。
```

### フェーズ 2: ORE_OBTAINED
```
王様: 聖鉱石を見つけたのだな。[>]
王様: 古代の剣が眠る部屋は古代の鍵で封じられている。[>]
王様: この古代の鍵を持っていけ。必ず役に立つはずだ。
```
**イベント**: 会話終了時に `tryGiveAncientKey()` が呼ばれ、古代の鍵が授与される

### フェーズ 3: ANCIENT_SWORD_READY
```
王様: 古代の剣を手に入れたのだな。[>]
王様: それと聖鉱石で聖剣を鍛えれば、竜に挑む力が備わる。鍛冶屋に頼むがよい。
```

### フェーズ 4: HOLY_SWORD_CREATED
```
王様: おお、見事な聖剣だ！[>]
王様: 約束通り、聖盾を授けよう。[>]
王様: これで竜にも立ち向かえるはずだ。
```
**イベント**: 会話終了時に `tryGrantHolyShield()` が呼ばれ、聖盾が授与される

### フェーズ 5: DRAGON_DEFEATED
```
王様: 竜を討ち倒したか！よくやった。[>]
王様: 島は救われた。心から礼を言おう。
```

---

## 鍛冶屋のセリフ

### 救出直後（洞窟1地下2階）
```
鍛冶屋: 助けてくれて本当に感謝する！[>]
鍛冶屋: だが聖鉱石はここにはなかった…。街へ戻るとしよう。
```
**イベント**: 会話終了時に `finalizeBlacksmithRescue()` が呼ばれ、鍛冶屋が街に出現

### ãã§ã¼ãº 1: BLACKSMITH_RESCUEDï¼åã®ãã³ãã¼æä¸åï¼
```
éå¶å±: å½ã®æ©äººã ãç¤¼ã«åã®ãã³ãã¼ãæ¸¡ããã[>]
éå¶å±: æ±ã®æµ·å²¸ã«å²©ã§å¡ãããæ´çªããããããã§ç ´ãã¦é²ãã
```
**ã¤ãã³ã**: ä¼è©±çµäºæã« `tryGivePowerHammer()` ãå¼ã°ããåã®ãã³ãã¼ãæä¸ããã

### ãã§ã¼ãº 1: BLACKSMITH_RESCUEDï¼åã®ãã³ãã¼æä¸å¾ï¼
```
éå¶å±: èé±ç³ã¯è¦ã¤ãã£ããï¼[>]
éå¶å±: æ±ã®æµ·å²¸ã®æ´çªã«ããã¯ãã ã
```
**æ¡ä»¶**: `hasHammer = true` ã¾ãã¯ `cave2Unlocked = true` ã®å ´åã«è¡¨ç¤ºãããç¹å¥ãªã»ãªã

### フェーズ 2: ORE_OBTAINED
```
鍛冶屋: おお、これが聖鉱石か！[>]
鍛冶屋: 聖剣を鍛えるには古代の剣が必要だ。[>]
鍛冶屋: 遺跡の奥にある鍵付きの部屋を探してくれ。古代の鍵は王様が持っているはずだ。
```

### フェーズ 3: ANCIENT_SWORD_READY
```
鍛冶屋: 古代の剣を手に入れたんだな！[>]
鍛冶屋: 聖鉱石と合わせれば聖剣を鍛えられる。材料を預かるぞ！
```
**イベント**: 会話終了時に `tryForgeHolySword()` が呼ばれ、古代の剣と聖鉱石が消費され聖剣が完成

### フェーズ 4: HOLY_SWORD_CREATED
```
鍛冶屋: 聖剣ができたか。あとはお前の腕次第だ。[>]
鍛冶屋: 竜に負けるなよ！
```

---

## ゲーム進行の流れ

### 第一章：依頼と状況把握
1. **島に漂着** → フィールドでスポーン
2. **神父と会話** → セーブ機能の説明
3. **王様と会話（フェーズ0）** → クエスト受注「遺跡の竜を倒せ」
4. **街の人々から情報収集** → 鍛冶屋が行方不明

### 第二章：鍛冶屋救出編
5. **商人で装備購入** → 木の剣・木の盾など
6. **洞窟1へ進入**（1層→2層）
7. **洞窟1の2層で鍛冶屋を発見** → 魔物と戦闘
8. **鍛冶屋を救出** → 洞窟で会話後、街へ帰還
9. **街の鍛冶屋と会話（フェーズ1）** → 「力のハンマー」入手

### 第三章：聖鉱石発見編
10. **東の洞窟2へ** → 力のハンマーで岩を破壊
11. **洞窟2攻略**（1層→2層）※強力な敵が出現
12. **洞窟2の2層の宝箱** → 「聖鉱石」入手

### 第四章：古代の剣入手編
13. **街へ帰還** → 鍛冶屋に聖鉱石を見せる（フェーズ2）
14. **王様と会話（フェーズ2）** → 「古代の鍵」入手
15. **遺跡2階へ** → 古代の鍵で鍵付き扉を開ける
16. **固定ダークナイト3体を撃破** → 古代の剣の部屋へ
17. **宝箱から「古代の剣」入手**

### 第五章：聖剣錬成編
18. **街へ帰還** → 鍛冶屋と会話（フェーズ3）
19. **古代の剣・聖鉱石を預ける** → 「聖剣」完成！装備

### 第六章：聖盾授与編
20. **王様と会話（フェーズ4）** → 聖剣を見せる
21. **「聖盾」入手！** → 装備
22. **神父でセーブ** → 最終決戦前の準備

### 最終章：竜討伐編
23. **遺跡1層へ進入** ※最強の敵が出現
24. **遺跡2層へ進む** → 階段で3層へ
25. **遺跡3層** → 最深部の王座の間へ
26. **古代竜と決戦** ※聖剣・聖盾が必要
27. **竜を倒す** → エンディング画面表示
28. **ゲームクリア！**

---

## 特殊イベント

### 力のハンマーイベント
- **トリガー**: 鍛冶屋（フェーズ1）との会話終了
- **効果**: POWER_HAMMER をインベントリに追加
- **用途**: フィールドの東にある岩を破壊して洞窟2へ進入

### 古代の鍵イベント
- **トリガー**: 王様（フェーズ2）との会話終了
- **効果**: ANCIENT_KEY をインベントリに追加
- **用途**: 遺跡2階の鍵付き扉を開ける（使用後消費）

### 聖剣錬成イベント
- **トリガー**: 鍛冶屋（フェーズ3）との会話終了
- **条件**: ANCIENT_SWORD と HOLY_ORE を所持
- **効果**:
  - ANCIENT_SWORD と HOLY_ORE が消費される
  - HOLY_SWORD がインベントリに追加される
  - `holySwordCreated` フラグが立つ

### 聖盾授与イベント
- **トリガー**: 王様（フェーズ4）との会話終了
- **条件**: 聖剣を錬成済み（`holySwordCreated = true`）
- **効果**:
  - HOLY_SHIELD がインベントリに追加される
  - `hasHolyShield` フラグが立つ

### 古代竜戦
- **場所**: 遺跡3階（RUINS_B3）
- **特殊ルール**:
  - 聖剣を装備していないと、竜にダメージを与えられない
  - 聖盾を装備していないと、竜の炎攻撃で2倍以上のダメージを受ける
- **勝利条件**: 聖剣と聖盾を装備して撃破
- **報酬**: エンディング画面へ遷移

---

## 会話システムの仕様

### 会話の進行
- **開始**: T キーで NPC に話しかける
- **続きの表示**: T キーで次のセリフへ進む
- **進行マーカー**: 続きがあるセリフには `[>]` が表示される
- **会話終了**: 最後のセリフには `[>]` がなく、空行で終了

### クールダウン
- 会話終了後、1回移動するまで同じ会話を再開できない
- `dialogueState.cooldownUntilMove` フラグで管理
- 移動時に `clearCooldown()` が呼ばれてリセット

### 特別なセリフ
特定の条件で通常とは異なるセリフが表示される：
- **鍛冶屋（フェーズ1）**: `hasHammer = true` → "1_after_hammer" セリフ
- **王様（フェーズ4）**: `hasHolyShield = true` → "3_after_shield" セリフ（未実装）

### フォールバック機能
- 指定されたフェーズのセリフがない場合、より前のフェーズのセリフを表示
- すべてのフェーズで見つからない場合: "特に反応がない。"

---

## 実装ファイル

- **dialogue.js**: 会話システムのロジック（324行）
- **assets/dialogues.json**: NPCセリフデータ（111行）
- **game_state.js**: イベント処理とフラグ管理
- **state/player_state.js**: 進行フラグの定義と初期化

---

**最終更新**: 2025-11-24