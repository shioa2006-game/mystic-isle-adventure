# ゲームフローとNPCセリフ整理

## ゲーム進行フェーズ
- フェーズ 0: START（開始）  
  - 状態: ゲーム開始直後  
  - 条件: なし  
  - 目標: 王様からクエストを受け、鍛冶屋を救出する
- フェーズ 1: BLACKSMITH_RESCUED（鍛冶屋救出）  
  - 状態: 鍛冶屋を洞窟1で救出済み  
  - 条件: `blacksmithRescued = true`  
  - 目標: 力のハンマーを入手し、東の洞窟2で聖鉱石を探す
- フェーズ 2: ORE_OBTAINED（聖鉱石入手）  
  - 状態: 洞窟2の地下2階で聖鉱石を入手  
  - 条件: `hasOre = true`  
  - 目標: 王様から古代の鍵を受け取り、遺跡の鍵付き扉を開ける
- フェーズ 3: ANCIENT_SWORD_READY（古代の剣入手）  
  - 状態: 遺跡2階で古代の剣を入手  
  - 条件: `hasAncientSword = true`  
  - 目標: 鍛冶屋に古代の剣と聖鉱石を渡して聖剣を錬成
- フェーズ 4: HOLY_SWORD_CREATED（聖剣完成）  
  - 状態: 聖剣の錬成が完了  
  - 条件: `holySwordCreated = true`  
  - 目標: 王様から聖盾を受け取り、遺跡の竜に挑む
- フェーズ 5: DRAGON_DEFEATED（竜討伐）  
  - 状態: 古代竜を討伐  
  - 条件: `dragonDefeated = true`  
  - 結果: エンディング画面表示

---

## 王様のセリフ
### フェーズ 0: START
```
王様: よく来た、若き冒険者よ。[>]
王様: 遺跡に恐ろしい竜が現れたのだ。[>]
王様: 倒すには伝説の聖剣と聖盾が必要だ。まず鍛冶屋を探し出してくれ。
```
**イベント**: 会話終了時に `questTalked` と `questGiven` フラグが立つ

### フェーズ 1: BLACKSMITH_RESCUED
```
王様: 鍛冶屋を助けてくれたそうだな。[>]
王様: 聖剣を鍛えるには聖鉱石が欠かせぬ。東の洞窟に眠っているはずだ。
```

### フェーズ 2: ORE_OBTAINED
```
王様: 聖鉱石を見つけたのだな。[>]
王様: 古代の剣が眠る部屋は古代の鍵で封じられている。[>]
王様: この古代の鍵を持っていけ。必ず役に立つはずだ。
```
**イベント**: 会話終了時に `tryGiveAncientKey()` が呼ばれ、古代の鍵が授与される

### フェーズ 2: ORE_OBTAINED（古代の鍵受け取り済み）
```
王様: 既に古代の鍵は持っているな。[>]
王様: 遺跡2階の鍵付きの扉を開け、古代の剣を手に入れるのだ。
```

### フェーズ 3: ANCIENT_SWORD_READY
```
王様: 古代の剣を手に入れたのだな。[>]
王様: それと聖鉱石で聖剣を鍛えれば、竜に挑む力が備わる。鍛冶屋に頼むがよい。
```

### フェーズ 4: HOLY_SWORD_CREATED
```
王様: おお、見事な聖剣だ！[>]
王様: 約束通り、聖盾を授けよう。[>]
王様: これで竜にも立ち向かえるはずだ。
```
**イベント**: 会話終了時に `tryGrantHolyShield()` が呼ばれ、聖盾が授与される

### フェーズ 5: DRAGON_DEFEATED
```
王様: 竜を討ち倒したか！よくやった。[>]
王様: 島は救われた。心から礼を言おう。
```

### 特別セリフ（シールド授与後の再訪・未実装）
```
王様: 聖剣と聖盾を手にしたな。[>]
王様: その力で竜を倒し、島を救ってくれ！
```

---

## 鍛冶屋のセリフ
### 救出直後（洞窟1 地下2階）
```
鍛冶屋: 助けてくれて本当に感謝する！[>]
鍛冶屋: だが聖鉱石はここにはなかった…。街へ戻るとしよう。
```
**イベント**: 会話終了時に `finalizeBlacksmithRescue()` が呼ばれ、鍛冶屋が街に移動

### フェーズ 1: BLACKSMITH_RESCUED（力のハンマー授与前・街）
```
鍛冶屋: 命の恩人だ。礼に力のハンマーを渡そう。[>]
鍛冶屋: 東の海岸に岩で塞がれた洞窟がある。これで砕いて進め。
```
**イベント**: 会話終了時に `tryGivePowerHammer()` が呼ばれ、力のハンマーを授与

### フェーズ 1: BLACKSMITH_RESCUED（力のハンマー授与後・街）
```
鍛冶屋: そのハンマーで東の海岸の岩を砕けるはずだ。[>]
鍛冶屋: 聖鉱石はその奥に眠っているはずだ。頼んだぞ。
```

### フェーズ 2: ORE_OBTAINED
```
鍛冶屋: おお、これが聖鉱石か！[>]
鍛冶屋: 聖剣を鍛えるには古代の剣が必要だ。[>]
鍛冶屋: 遺跡の奥にある鍵付きの部屋を探してくれ。古代の鍵は王様が持っているはずだ。
```

### フェーズ 3: ANCIENT_SWORD_READY（錬成前）
```
鍛冶屋: 古代の剣を手に入れたんだな！[>]
鍛冶屋: 聖鉱石と合わせれば聖剣を鍛えられる。材料を預かるぞ！
```
**イベント**: 会話終了時に `tryForgeHolySword()` が呼ばれ、古代の剣と聖鉱石が消費され聖剣が完成

### フェーズ 4: HOLY_SWORD_CREATED（錬成後）
```
鍛冶屋: 聖剣ができたか。あとはお前の腕次第だ。[>]
鍛冶屋: 竜に負けるなよ！
```

---

## 商人のセリフ
- フェーズ 0:  
  - 「いらっしゃい！旅に必要なものはそろってるよ。[>]」  
  - 「食料が切れると危ないから、余裕をもって買っておきな。」
- フェーズ 2:  
  - 「聖鉱石を見つけたんだって？[>]」  
  - 「鍛冶屋が言ってたよ。古代の剣が必要らしい。遺跡の奥を探してみな。」
- フェーズ 5:  
  - 「竜を倒したんだって？すごいじゃないか！[>]」  
  - 「次の冒険も備えて、装備を整えておくといいよ。」

## 神父のセリフ
- フェーズ 0:  
  - 「お疲れでしょう。祈りとともに、ここで一息つきなさい。[>]」  
  - 「セーブをしておけば、いつでもここから再開できますよ。」

## 宿屋のセリフ
- フェーズ 0:  
  - 「ようこそ。ここで休めばHPも気力も回復するよ。[>]」  
  - 「旅はまだ続く。無理せず休んでおくれ。」

---

## ゲーム進行の流れ
### 第一章：依頼と状況把握
1. 島に漂着 → フィールドでスポーン  
2. 神父と会話 → セーブ機能の説明  
3. 王様と会話（フェーズ0） → クエスト受注「遺跡の竜を倒せ」  
4. 街の人々から情報収集 → 鍛冶屋が行方不明

### 第二章：鍛冶屋救出編
5. 商人で装備購入 → 木の剣・木の盾など  
6. 洞窟1へ進入 → 層を下りる  
7. 洞窟1の2層で鍛冶屋を発見 → 魔物と戦闘  
8. 鍛冶屋を救出 → 洞窟で会話後、街へ帰還  
9. 街の鍛冶屋と会話（フェーズ1） → 「力のハンマー」入手

### 第三章：聖鉱石発見編
10. 東の洞窟2へ → 力のハンマーで岩を破壊  
11. 洞窟2を攻略 → 層を下りる  
12. 洞窟2の2層の宝箱 → 「聖鉱石」入手

### 第四章：古代の剣入手編
13. 街へ帰還 → 鍛冶屋に聖鉱石を見せる（フェーズ2）  
14. 王様と会話（フェーズ2） → 「古代の鍵」入手  
15. 遺跡2階へ → 古代の鍵で鍵付き扉を開ける  
16. 固定ダークナイト3体を撃破 → 古代の剣の部屋へ  
17. 宝箱から「古代の剣」入手

### 第五章：聖剣錬成編
18. 街へ帰還 → 鍛冶屋と会話（フェーズ3）  
19. 古代の剣・聖鉱石を預ける → 「聖剣」完成・装備

### 第六章：聖盾授与編
20. 王様と会話（フェーズ4） → 聖剣を見せる  
21. 「聖盾」入手 → 装備  
22. 神父でセーブ → 最終決戦前の準備

### 最終章：竜討伐編
23. 遺跡1層へ進入 → 強敵が出現  
24. 遺跡2層へ進む → 階段で3層へ  
25. 遺跡3層 → 最深部の王座の間へ  
26. 古代竜と決戦 → 聖剣・聖盾が必要  
27. 竜を倒す → エンディング画面表示  
28. ゲームクリア

---

## 特殊イベント
### 力のハンマーイベント
- トリガー: 鍛冶屋（フェーズ1）との会話終了  
- 効果: POWER_HAMMER をインベントリに追加  
- 用途: フィールド東の岩を破壊して洞窟2へ進入

### 古代の鍵イベント
- トリガー: 王様（フェーズ2）との会話終了  
- 効果: ANCIENT_KEY をインベントリに追加  
- 用途: 遺跡2階の鍵付き扉を開ける（使用後に消費）

### 聖剣錬成イベント
- トリガー: 鍛冶屋（フェーズ3）との会話終了  
- 条件: ANCIENT_SWORD と HOLY_ORE を所持  
- 効果:  
  - ANCIENT_SWORD と HOLY_ORE が消費される  
  - HOLY_SWORD がインベントリに追加される  
  - `holySwordCreated` フラグが立つ

### 聖盾授与イベント
- トリガー: 王様（フェーズ4）との会話終了  
- 条件: 聖剣を錬成済み（`holySwordCreated = true`）  
- 効果:  
  - HOLY_SHIELD がインベントリに追加される  
  - `hasHolyShield` フラグが立つ

### 古代竜戦
- 場所: 遺跡3階（RUINS_B3）  
- 特殊ルール:  
  - 聖剣を装備していないと、竜にダメージを与えられない  
  - 聖盾を装備していないと、竜の炎攻撃で2倍以上のダメージを受ける  
- 勝利条件: 聖剣と聖盾を装備して撃破  
- 報酬: エンディング画面へ遷移

---

## 会話システムの仕組み
- 開始: T キーで NPC に話しかける  
- 続きの表示: T キーで次のセリフへ進む  
- 進行マーカー: 続きがあるセリフには `[>]` が表示される  
- 会話終了: 最後のセリフには `[>]` がなく、空行で終わる  
- クールダウン: 会話終了後、1回移動するまで同じ会話を再開できない（`dialogueState.cooldownUntilMove` で管理）  
- 特別セリフ: 条件に応じて通常とは異なるセリフを表示  
  - 鍛冶屋（フェーズ1）: `hasHammer = true` → "1_after_hammer" セリフ  
  - 王様（フェーズ4）: `hasHolyShield = true` → "3_after_shield" セリフ（未実装）  
- フォールバック: 持っていないフェーズのセリフがない場合、より前のフェーズのセリフを表示。全フェーズで見つからない場合は「特に反応がない」

---

## 実装ファイル
- `dialogue.js`: 会話システムのロジックと状態管理（249行）  
- `assets/dialogues.json`: NPCセリフデータ（王様、商人、宿屋、神父、鍛冶屋）  
- `game_state.js`: イベント進行とフラグ管理  
- `state/player_state.js`: 進行フラグの定義と初期値

---

最終更新: 2025-12-01
